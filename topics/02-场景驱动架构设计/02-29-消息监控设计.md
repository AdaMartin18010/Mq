# 2.29 消息监控设计

## 目录

- [2.29 消息监控设计](#229-消息监控设计)
  - [目录](#目录)
  - [2.29.1 监控场景](#2291-监控场景)
    - [常见场景](#常见场景)
  - [2.29.2 Kafka监控](#2292-kafka监控)
    - [监控指标](#监控指标)
    - [Prometheus监控](#prometheus监控)
  - [2.29.3 NATS监控](#2293-nats监控)
    - [监控指标](#监控指标-1)
    - [Prometheus监控](#prometheus监控-1)
  - [2.29.4 RabbitMQ监控](#2294-rabbitmq监控)
    - [监控指标](#监控指标-2)
    - [Prometheus监控](#prometheus监控-2)
  - [2.29.5 监控最佳实践](#2295-监控最佳实践)
    - [设计建议](#设计建议)

---

## 2.29.1 监控场景

### 常见场景

1. **性能监控**
   - 吞吐量监控
   - 延迟监控
   - 资源使用监控

2. **健康监控**
   - 服务健康检查
   - 连接状态监控
   - 错误率监控

3. **业务监控**
   - 消息量监控
   - 消费进度监控
   - 积压监控

---

## 2.29.2 Kafka监控

### 监控指标

```java
// JMX监控指标
// 吞吐量指标
kafka.server:type=BrokerTopicMetrics,name=MessagesInPerSec
kafka.server:type=BrokerTopicMetrics,name=BytesInPerSec
kafka.server:type=BrokerTopicMetrics,name=BytesOutPerSec

// 延迟指标
kafka.network:type=RequestMetrics,name=TotalTimeMs

// 分区指标
kafka.log:type=Log,name=Size,topic=orders,partition=0
```

### Prometheus监控

```yaml
# Prometheus配置
scrape_configs:
  - job_name: 'kafka'
    static_configs:
      - targets: ['localhost:9092']
```

---

## 2.29.3 NATS监控

### 监控指标

```go
// NATS监控端点
// HTTP监控端点
http://localhost:8222/varz  // 变量信息
http://localhost:8222/connz  // 连接信息
http://localhost:8222/subsz  // 订阅信息
http://localhost:8222/routez  // 路由信息

// JetStream监控
http://localhost:8222/jsz  // JetStream统计
```

### Prometheus监控

```yaml
# Prometheus配置
scrape_configs:
  - job_name: 'nats'
    static_configs:
      - targets: ['localhost:8222']
```

---

## 2.29.4 RabbitMQ监控

### 监控指标

```python
# RabbitMQ管理API
import requests

# 队列监控
response = requests.get('http://localhost:15672/api/queues',
                       auth=('guest', 'guest'))
queues = response.json()

# 连接监控
response = requests.get('http://localhost:15672/api/connections',
                       auth=('guest', 'guest'))
connections = response.json()
```

### Prometheus监控

```yaml
# Prometheus配置
scrape_configs:
  - job_name: 'rabbitmq'
    static_configs:
      - targets: ['localhost:15692']
```

---

## 2.29.5 监控最佳实践

### 设计建议

1. **监控设计**
   - 关键指标监控
   - 告警规则设计
   - 仪表板设计

2. **性能优化**
   - 监控数据采集
   - 监控数据存储
   - 监控查询优化

3. **运维管理**
   - 监控告警
   - 监控分析
   - 监控优化

---

**最后更新**: 2025-12-31
