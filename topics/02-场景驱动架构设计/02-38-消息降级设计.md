# 2.38 消息降级设计

## 目录

- [2.38 消息降级设计](#238-消息降级设计)
  - [目录](#目录)
  - [2.38.1 降级场景](#2381-降级场景)
    - [常见场景](#常见场景)
  - [2.38.2 Kafka降级](#2382-kafka降级)
    - [降级实现](#降级实现)
  - [2.38.3 NATS降级](#2383-nats降级)
    - [降级实现](#降级实现-1)
  - [2.38.4 RabbitMQ降级](#2384-rabbitmq降级)
    - [降级实现](#降级实现-2)
  - [2.38.5 降级最佳实践](#2385-降级最佳实践)
    - [设计建议](#设计建议)

---

## 2.38.1 降级场景

### 常见场景

1. **系统过载**
   - 流量激增
   - 资源不足
   - 性能下降

2. **服务故障**
   - 下游服务不可用
   - 网络故障
   - 数据库故障

3. **业务降级**
   - 非核心功能降级
   - 优先级调整
   - 功能开关

---

## 2.38.2 Kafka降级

### 降级实现

```java
// 降级策略
public class MessageDegradeStrategy {
    private CircuitBreaker circuitBreaker;

    public void sendMessage(ProducerRecord<String, String> record) {
        if (circuitBreaker.isOpen()) {
            // 降级处理：写入本地文件
            degradeToLocalFile(record);
            return;
        }

        try {
            producer.send(record);
        } catch (Exception e) {
            // 失败降级
            if (shouldDegrade(e)) {
                degradeToLocalFile(record);
                circuitBreaker.recordFailure();
            }
        }
    }

    private void degradeToLocalFile(ProducerRecord<String, String> record) {
        // 写入本地文件，后续补偿
        writeToLocalFile(record);
    }
}
```

---

## 2.38.3 NATS降级

### 降级实现

```go
// 降级策略
type DegradeStrategy struct {
    circuitBreaker *CircuitBreaker
    localStorage  *LocalStorage
}

func (ds *DegradeStrategy) Publish(subject string, data []byte) error {
    if ds.circuitBreaker.IsOpen() {
        // 降级处理：写入本地存储
        return ds.localStorage.Save(subject, data)
    }

    err := nc.Publish(subject, data)
    if err != nil {
        if ds.shouldDegrade(err) {
            ds.localStorage.Save(subject, data)
            ds.circuitBreaker.RecordFailure()
        }
        return err
    }

    ds.circuitBreaker.RecordSuccess()
    return nil
}
```

---

## 2.38.4 RabbitMQ降级

### 降级实现

```python
# 降级策略
class MessageDegradeStrategy:
    def __init__(self):
        self.circuit_breaker = CircuitBreaker()
        self.local_storage = LocalStorage()

    def publish_message(self, exchange, routing_key, message):
        if self.circuit_breaker.is_open():
            # 降级处理：写入本地存储
            self.local_storage.save(exchange, routing_key, message)
            return

        try:
            channel.basic_publish(
                exchange=exchange,
                routing_key=routing_key,
                body=message
            )
        except Exception as e:
            if self.should_degrate(e):
                self.local_storage.save(exchange, routing_key, message)
                self.circuit_breaker.record_failure()
            raise
        else:
            self.circuit_breaker.record_success()
```

---

## 2.38.5 降级最佳实践

### 设计建议

1. **降级策略**
   - 熔断降级
   - 限流降级
   - 超时降级

2. **降级处理**
   - 本地存储
   - 异步补偿
   - 降级通知

3. **降级恢复**
   - 自动恢复
   - 手动恢复
   - 降级监控

---

**最后更新**: 2025-12-31
