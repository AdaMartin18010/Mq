# 2.18 消息过滤策略

## 目录

- [2.18 消息过滤策略](#218-消息过滤策略)
  - [目录](#目录)
  - [2.18.1 过滤场景](#2181-过滤场景)
    - [常见场景](#常见场景)
  - [2.18.2 Kafka消息过滤](#2182-kafka消息过滤)
    - [Consumer过滤](#consumer过滤)
    - [过滤建议](#过滤建议)
  - [2.18.3 NATS消息过滤](#2183-nats消息过滤)
    - [Subject过滤](#subject过滤)
    - [过滤特性](#过滤特性)
  - [2.18.4 RabbitMQ消息过滤](#2184-rabbitmq消息过滤)
    - [Exchange过滤](#exchange过滤)
  - [2.18.5 过滤最佳实践](#2185-过滤最佳实践)
    - [设计建议](#设计建议)

---

## 2.18.1 过滤场景

### 常见场景

1. **内容过滤**
   - 根据消息内容过滤
   - 条件匹配
   - 规则引擎

2. **路由过滤**
   - 根据路由键过滤
   - 主题匹配
   - 通配符匹配

3. **时间过滤**
   - 时间窗口过滤
   - 过期消息过滤
   - 延迟消息处理

---

## 2.18.2 Kafka消息过滤

### Consumer过滤

```java
// 消费者端过滤
consumer.subscribe(Collections.singletonList("orders"));
while (true) {
    ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(100));
    for (ConsumerRecord<String, String> record : records) {
        // 应用层过滤
        if (shouldProcess(record.value())) {
            process(record);
        }
    }
}
```

### 过滤建议

- 应用层过滤
- 使用Kafka Streams
- 合理使用分区

---

## 2.18.3 NATS消息过滤

### Subject过滤

```go
// 通配符过滤
sub, _ := nc.Subscribe("orders.*.created", func(msg *nats.Msg) {
    // 只接收订单创建消息
    process(msg)
})

// 队列组过滤
sub, _ := nc.QueueSubscribe("orders.*", "workers", func(msg *nats.Msg) {
    // 负载均衡过滤
    process(msg)
})
```

### 过滤特性

- **通配符**：`*`（单级）、`>`（多级）
- **队列组**：负载均衡过滤
- **应用层**：消息内容过滤

---

## 2.18.4 RabbitMQ消息过滤

### Exchange过滤

```python
# Topic Exchange过滤
channel.exchange_declare(exchange='orders', exchange_type='topic')

# 绑定特定路由键
channel.queue_bind(
    exchange='orders',
    queue='order-created',
    routing_key='order.created'  # 只接收创建消息
)

# Headers Exchange过滤
channel.exchange_declare(exchange='orders', exchange_type='headers')
channel.queue_bind(
    exchange='orders',
    queue='high-priority',
    arguments={'priority': 'high', 'x-match': 'all'}
)
```

---

## 2.18.5 过滤最佳实践

### 设计建议

1. **过滤位置**
   - Broker层过滤（高效）
   - 应用层过滤（灵活）

2. **性能考虑**
   - 减少不必要传输
   - 合理使用通配符
   - 避免过度过滤

3. **监控告警**
   - 监控过滤率
   - 告警异常过滤
   - 优化过滤规则

---

**最后更新**: 2025-12-31
