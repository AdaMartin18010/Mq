# 2.19 消息优先级设计

## 目录

- [2.19 消息优先级设计](#219-消息优先级设计)
  - [目录](#目录)
  - [2.19.1 优先级场景](#2191-优先级场景)
    - [常见场景](#常见场景)
  - [2.19.2 Kafka优先级](#2192-kafka优先级)
    - [实现方式](#实现方式)
    - [优先级策略](#优先级策略)
  - [2.19.3 NATS优先级](#2193-nats优先级)
    - [实现方式](#实现方式-1)
  - [2.19.4 RabbitMQ优先级](#2194-rabbitmq优先级)
    - [优先级队列](#优先级队列)
  - [2.19.5 优先级最佳实践](#2195-优先级最佳实践)
    - [设计建议](#设计建议)

---

## 2.19.1 优先级场景

### 常见场景

1. **业务优先级**
   - 高优先级订单
   - 紧急通知
   - VIP用户消息

2. **系统优先级**
   - 告警消息
   - 系统事件
   - 监控数据

3. **时间优先级**
   - 实时消息
   - 批量消息
   - 延迟消息

---

## 2.19.2 Kafka优先级

### 实现方式

```java
// 使用不同Topic实现优先级
String highPriorityTopic = "orders-high";
String normalPriorityTopic = "orders-normal";

// 高优先级消息
producer.send(new ProducerRecord<>(highPriorityTopic, key, value));

// 普通优先级消息
producer.send(new ProducerRecord<>(normalPriorityTopic, key, value));

// 消费者优先消费高优先级Topic
consumer.subscribe(Arrays.asList(highPriorityTopic, normalPriorityTopic));
```

### 优先级策略

- **多Topic策略**：不同优先级使用不同Topic
- **分区策略**：高优先级使用独立分区
- **Consumer策略**：优先消费高优先级Topic

---

## 2.19.3 NATS优先级

### 实现方式

```go
// 使用不同Subject实现优先级
highPrioritySubject := "orders.high"
normalPrioritySubject := "orders.normal"

// 高优先级消息
nc.Publish(highPrioritySubject, data)

// 普通优先级消息
nc.Publish(normalPrioritySubject, data)

// 消费者订阅多个Subject
nc.Subscribe(highPrioritySubject, handleHighPriority)
nc.Subscribe(normalPrioritySubject, handleNormalPriority)
```

---

## 2.19.4 RabbitMQ优先级

### 优先级队列

```python
# 声明优先级队列
channel.queue_declare(
    queue='orders',
    durable=True,
    arguments={'x-max-priority': 10}  # 最大优先级10
)

# 发送高优先级消息
channel.basic_publish(
    exchange='',
    routing_key='orders',
    body=message,
    properties=pika.BasicProperties(
        priority=10,  # 高优先级
        delivery_mode=2
    )
)

# 发送普通优先级消息
channel.basic_publish(
    exchange='',
    routing_key='orders',
    body=message,
    properties=pika.BasicProperties(
        priority=1,  # 普通优先级
        delivery_mode=2
    )
)
```

---

## 2.19.5 优先级最佳实践

### 设计建议

1. **优先级设计**
   - 合理分级（3-5级）
   - 避免过度分级
   - 明确优先级规则

2. **实现方式**
   - 系统原生支持（RabbitMQ）
   - 多Topic/Subject（Kafka/NATS）
   - 应用层实现

3. **监控告警**
   - 监控优先级分布
   - 告警高优先级积压
   - 优化优先级策略

---

**最后更新**: 2025-12-31
