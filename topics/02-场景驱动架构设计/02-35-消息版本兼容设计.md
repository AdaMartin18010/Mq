# 2.35 消息版本兼容设计

## 目录

- [2.35 消息版本兼容设计](#235-消息版本兼容设计)
  - [目录](#目录)
  - [2.35.1 版本兼容场景](#2351-版本兼容场景)
    - [常见场景](#常见场景)
  - [2.35.2 Kafka版本兼容](#2352-kafka版本兼容)
    - [版本管理](#版本管理)
  - [2.35.3 NATS版本兼容](#2353-nats版本兼容)
    - [版本管理](#版本管理-1)
  - [2.35.4 RabbitMQ版本兼容](#2354-rabbitmq版本兼容)
    - [版本管理](#版本管理-2)
  - [2.35.5 版本兼容最佳实践](#2355-版本兼容最佳实践)
    - [设计建议](#设计建议)

---

## 2.35.1 版本兼容场景

### 常见场景

1. **Schema演进**
   - Schema版本管理
   - 向前兼容
   - 向后兼容

2. **消息版本**
   - 消息格式版本
   - 协议版本
   - API版本

3. **系统升级**
   - 滚动升级
   - 零停机升级
   - 版本迁移

---

## 2.35.2 Kafka版本兼容

### 版本管理

```java
// Schema Registry版本管理
// 注册Schema
Schema schema = new Schema.Parser().parse(schemaString);
SchemaRegistryClient client = new CachedSchemaRegistryClient(
    "http://localhost:8081", 100
);
int schemaId = client.register("orders-value", schema);

// 兼容性检查
CompatibilityLevel level = client.getCompatibility("orders-value");
// BACKWARD, FORWARD, FULL, NONE

// 版本化消息
ProducerRecord<String, GenericRecord> record = new ProducerRecord<>(
    "orders",
    key,
    new GenericRecordBuilder(schema)
        .set("version", "1.0")
        .set("orderId", orderId)
        .build()
);
```

---

## 2.35.3 NATS版本兼容

### 版本管理

```go
// 消息版本管理
type MessageV1 struct {
    Version string `json:"version"`
    OrderID string `json:"orderId"`
}

type MessageV2 struct {
    Version string `json:"version"`
    OrderID string `json:"orderId"`
    Timestamp int64 `json:"timestamp"`
}

// 版本路由
nc.Subscribe("orders.*", func(msg *nats.Msg) {
    version := extractVersion(msg.Data)
    switch version {
    case "1.0":
        processV1(msg.Data)
    case "2.0":
        processV2(msg.Data)
    default:
        processDefault(msg.Data)
    }
})
```

---

## 2.35.4 RabbitMQ版本兼容

### 版本管理

```python
# 消息版本管理
def process_message(ch, method, properties, body):
    message = json.loads(body)
    version = message.get('version', '1.0')

    if version == '1.0':
        process_v1(message)
    elif version == '2.0':
        process_v2(message)
    else:
        process_default(message)

    ch.basic_ack(delivery_tag=method.delivery_tag)

# 版本化消息
message = {
    'version': '2.0',
    'orderId': order_id,
    'timestamp': int(time.time())
}
channel.basic_publish(
    exchange='orders',
    routing_key='',
    body=json.dumps(message)
)
```

---

## 2.35.5 版本兼容最佳实践

### 设计建议

1. **版本设计**
   - 语义化版本
   - 版本策略
   - 兼容性规则

2. **兼容性管理**
   - 向前兼容
   - 向后兼容
   - 不兼容变更

3. **迁移策略**
   - 渐进式迁移
   - 版本共存
   - 降级策略

---

**最后更新**: 2025-12-31
