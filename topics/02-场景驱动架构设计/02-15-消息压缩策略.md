# 2.15 消息压缩策略

## 目录

- [2.15 消息压缩策略](#215-消息压缩策略)
  - [目录](#目录)
  - [2.15.1 压缩算法对比](#2151-压缩算法对比)
    - [算法特性](#算法特性)
  - [2.15.2 Kafka压缩](#2152-kafka压缩)
    - [Producer压缩](#producer压缩)
    - [压缩效果](#压缩效果)
  - [2.15.3 NATS压缩](#2153-nats压缩)
    - [消息压缩](#消息压缩)
    - [建议](#建议)
  - [2.15.4 RabbitMQ压缩](#2154-rabbitmq压缩)
    - [消息压缩](#消息压缩-1)
  - [2.15.5 压缩选择指南](#2155-压缩选择指南)
    - [选择建议](#选择建议)

---

## 2.15.1 压缩算法对比

### 算法特性

| 算法 | 压缩比 | 速度 | CPU消耗 | 适用场景 |
|------|--------|------|---------|---------|
| **gzip** | 高 | 慢 | 高 | 高压缩比需求 |
| **snappy** | 中 | 快 | 低 | 实时场景 |
| **lz4** | 中 | 很快 | 很低 | 高性能场景 |
| **zstd** | 很高 | 快 | 中 | 平衡场景 |

---

## 2.15.2 Kafka压缩

### Producer压缩

```properties
# 启用LZ4压缩
compression.type=lz4

# 批量大小
batch.size=131072
```

### 压缩效果

- **LZ4**：压缩比约2-3倍，CPU消耗低
- **Snappy**：压缩比约2倍，速度较快
- **Gzip**：压缩比约3-4倍，CPU消耗高

---

## 2.15.3 NATS压缩

### 消息压缩

```go
// NATS本身不提供压缩
// 可在应用层压缩
compressed := compress(data)
nc.Publish("topic", compressed)
```

### 建议

- 应用层压缩
- 使用LZ4或Snappy
- 大消息才压缩

---

## 2.15.4 RabbitMQ压缩

### 消息压缩

```python
import gzip

# 压缩消息
compressed = gzip.compress(message.encode())
channel.basic_publish(
    exchange='',
    routing_key='queue',
    body=compressed,
    properties=pika.BasicProperties(
        content_encoding='gzip'
    )
)
```

---

## 2.15.5 压缩选择指南

### 选择建议

1. **高吞吐量场景**
   - 使用LZ4
   - 低CPU消耗
   - 快速压缩

2. **高压缩比场景**
   - 使用Gzip或Zstd
   - 节省存储
   - 网络传输

3. **实时场景**
   - 使用Snappy
   - 平衡压缩和速度

---

**最后更新**: 2025-12-31
