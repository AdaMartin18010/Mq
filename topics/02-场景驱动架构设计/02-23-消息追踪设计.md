# 2.23 消息追踪设计

## 目录

- [2.23 消息追踪设计](#223-消息追踪设计)
  - [目录](#目录)
  - [2.23.1 追踪场景](#2231-追踪场景)
    - [常见场景](#常见场景)
  - [2.23.2 Kafka消息追踪](#2232-kafka消息追踪)
    - [实现方式](#实现方式)
    - [集成OpenTracing](#集成opentracing)
  - [2.23.3 NATS消息追踪](#2233-nats消息追踪)
    - [实现方式](#实现方式-1)
  - [2.23.4 RabbitMQ消息追踪](#2234-rabbitmq消息追踪)
    - [实现方式](#实现方式-2)
  - [2.23.5 追踪最佳实践](#2235-追踪最佳实践)
    - [设计建议](#设计建议)

---

## 2.23.1 追踪场景

### 常见场景

1. **问题排查**
   - 消息流向追踪
   - 性能瓶颈定位
   - 错误根因分析

2. **业务监控**
   - 业务流程追踪
   - 端到端延迟
   - 消息处理链路

3. **合规审计**
   - 消息审计日志
   - 操作追踪
   - 合规要求

---

## 2.23.2 Kafka消息追踪

### 实现方式

```java
// 添加追踪头
ProducerRecord<String, String> record = new ProducerRecord<>("orders", key, value);
record.headers().add("trace-id", traceId.getBytes());
record.headers().add("span-id", spanId.getBytes());
producer.send(record);

// Consumer读取追踪头
for (ConsumerRecord<String, String> record : records) {
    String traceId = new String(record.headers().lastHeader("trace-id").value());
    String spanId = new String(record.headers().lastHeader("span-id").value());
    // 处理消息并传递追踪信息
}
```

### 集成OpenTracing

```java
// 使用OpenTracing
Tracer tracer = GlobalTracer.get();
Span span = tracer.nextSpan()
    .name("kafka-produce")
    .tag("topic", "orders")
    .start();
try {
    producer.send(record);
} finally {
    span.end();
}
```

---

## 2.23.3 NATS消息追踪

### 实现方式

```go
// 添加追踪头
msg := nats.NewMsg("orders")
msg.Data = []byte(data)
msg.Header.Set("trace-id", traceID)
msg.Header.Set("span-id", spanID)
nc.PublishMsg(msg)

// 订阅读取追踪头
nc.Subscribe("orders", func(msg *nats.Msg) {
    traceID := msg.Header.Get("trace-id")
    spanID := msg.Header.Get("span-id")
    // 处理消息并传递追踪信息
})
```

---

## 2.23.4 RabbitMQ消息追踪

### 实现方式

```python
# 添加追踪头
properties = pika.BasicProperties(
    headers={
        'trace-id': trace_id,
        'span-id': span_id
    }
)
channel.basic_publish(
    exchange='orders',
    routing_key='',
    body=message,
    properties=properties
)

# 消费读取追踪头
def callback(ch, method, properties, body):
    trace_id = properties.headers.get('trace-id')
    span_id = properties.headers.get('span-id')
    # 处理消息并传递追踪信息
```

---

## 2.23.5 追踪最佳实践

### 设计建议

1. **追踪设计**
   - 统一追踪格式
   - 跨系统传递
   - 采样策略

2. **性能考虑**
   - 追踪开销
   - 采样率设置
   - 存储优化

3. **工具集成**
   - OpenTracing/Jaeger
   - Zipkin
   - 自定义追踪系统

---

**最后更新**: 2025-12-31
