# 2.11 数据一致性保障

## 目录

- [2.11 数据一致性保障](#211-数据一致性保障)
  - [目录](#目录)
  - [2.11.1 一致性模型](#2111-一致性模型)
    - [一致性级别](#一致性级别)
  - [2.11.2 Kafka一致性保障](#2112-kafka一致性保障)
    - [ISR机制](#isr机制)
    - [事务支持](#事务支持)
  - [2.11.3 NATS一致性保障](#2113-nats一致性保障)
    - [JetStream持久化](#jetstream持久化)
    - [消息确认](#消息确认)
  - [2.11.4 RabbitMQ一致性保障](#2114-rabbitmq一致性保障)
    - [持久化配置](#持久化配置)
  - [2.11.5 最佳实践](#2115-最佳实践)
    - [一致性选择](#一致性选择)
    - [保障措施](#保障措施)

---

## 2.11.1 一致性模型

### 一致性级别

1. **强一致性**
   - 所有副本同步更新
   - 高延迟，高可靠性

2. **最终一致性**
   - 异步复制
   - 低延迟，最终一致

3. **弱一致性**
   - 不保证一致性
   - 最低延迟

---

## 2.11.2 Kafka一致性保障

### ISR机制

```properties
# 至少2个副本同步
min.insync.replicas=2

# 生产者确认
acks=all

# 禁止不干净Leader选举
unclean.leader.election.enable=false
```

### 事务支持

```java
// 事务性Producer
producer.initTransactions();
producer.beginTransaction();
producer.send(record);
producer.commitTransaction();
```

---

## 2.11.3 NATS一致性保障

### JetStream持久化

```go
// 创建持久化Stream
js.AddStream(&nats.StreamConfig{
    Name:     "ORDERS",
    Subjects: []string{"orders.*"},
    Replicas: 3,
})
```

### 消息确认

```go
// 手动确认
msg.Ack()
```

---

## 2.11.4 RabbitMQ一致性保障

### 持久化配置

```python
# 持久化队列
channel.queue_declare(queue='task_queue', durable=True)

# 持久化消息
channel.basic_publish(
    exchange='',
    routing_key='task_queue',
    body=message,
    properties=pika.BasicProperties(
        delivery_mode=2,  # 持久化
    ))
```

---

## 2.11.5 最佳实践

### 一致性选择

- **金融交易**：强一致性（Kafka事务）
- **日志聚合**：最终一致性（Kafka异步复制）
- **实时通信**：弱一致性（NATS Core）

### 保障措施

1. **配置正确**：设置合适的副本数和确认机制
2. **监控告警**：监控副本同步状态
3. **定期验证**：验证数据一致性

---

**最后更新**: 2025-12-31
