# 2.33 消息转换与适配设计

## 目录

- [2.33 消息转换与适配设计](#233-消息转换与适配设计)
  - [目录](#目录)
  - [2.33.1 转换适配场景](#2331-转换适配场景)
    - [常见场景](#常见场景)
  - [2.33.2 Kafka转换适配](#2332-kafka转换适配)
    - [转换实现](#转换实现)
  - [2.33.3 NATS转换适配](#2333-nats转换适配)
    - [转换实现](#转换实现-1)
  - [2.33.4 RabbitMQ转换适配](#2334-rabbitmq转换适配)
    - [转换实现](#转换实现-2)
  - [2.33.5 转换适配最佳实践](#2335-转换适配最佳实践)
    - [设计建议](#设计建议)

---

## 2.33.1 转换适配场景

### 常见场景

1. **格式转换**
   - JSON转Protobuf
   - XML转JSON
   - 数据格式适配

2. **协议适配**
   - 不同协议转换
   - 协议桥接
   - 系统集成

3. **数据适配**
   - 字段映射
   - 数据清洗
   - 数据增强

---

## 2.33.2 Kafka转换适配

### 转换实现

```java
// 使用Kafka Connect进行转换
// Source Connector配置
{
  "name": "jdbc-source",
  "config": {
    "connector.class": "io.confluent.connect.jdbc.JdbcSourceConnector",
    "transforms": "convert",
    "transforms.convert.type": "org.apache.kafka.connect.transforms.Convert",
    "transforms.convert.field": "value",
    "transforms.convert.schema.type": "string"
  }
}

// 使用Kafka Streams进行转换
KStream<String, String> stream = builder.stream("input-topic");
KStream<String, String> transformed = stream
    .mapValues(value -> transformValue(value))
    .to("output-topic");
```

---

## 2.33.3 NATS转换适配

### 转换实现

```go
// 消息转换
nc.Subscribe("input.subject", func(msg *nats.Msg) {
    // 转换消息格式
    transformed := transformMessage(msg.Data)

    // 发布到目标Subject
    nc.Publish("output.subject", transformed)
})

// 协议适配
func adaptProtocol(input []byte) []byte {
    // 协议转换逻辑
    return convert(input)
}
```

---

## 2.33.4 RabbitMQ转换适配

### 转换实现

```python
# 消息转换
def transform_message(ch, method, properties, body):
    # 转换消息格式
    transformed = json.loads(body)
    transformed['processed_at'] = datetime.now().isoformat()

    # 发布到目标Exchange
    ch.basic_publish(
        exchange='output-exchange',
        routing_key='transformed',
        body=json.dumps(transformed)
    )
    ch.basic_ack(delivery_tag=method.delivery_tag)

# 绑定转换
channel.queue_bind(
    exchange='input-exchange',
    queue='transform-queue',
    routing_key='input'
)
channel.basic_consume(queue='transform-queue', on_message_callback=transform_message)
```

---

## 2.33.5 转换适配最佳实践

### 设计建议

1. **转换设计**
   - 明确转换规则
   - 转换性能优化
   - 错误处理

2. **适配设计**
   - 协议适配层
   - 数据格式适配
   - 向后兼容

3. **性能优化**
   - 转换缓存
   - 批量转换
   - 异步转换

---

**最后更新**: 2025-12-31
