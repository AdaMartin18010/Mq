# 2.21 消息事务设计

## 目录

- [2.21 消息事务设计](#221-消息事务设计)
  - [目录](#目录)
  - [2.21.1 事务场景](#2211-事务场景)
    - [常见场景](#常见场景)
  - [2.21.2 Kafka事务](#2212-kafka事务)
    - [事务Producer](#事务producer)
    - [事务Consumer](#事务consumer)
  - [2.21.3 NATS事务](#2213-nats事务)
    - [事务实现](#事务实现)
  - [2.21.4 RabbitMQ事务](#2214-rabbitmq事务)
    - [事务Channel](#事务channel)
    - [发布确认](#发布确认)
  - [2.21.5 事务最佳实践](#2215-事务最佳实践)
    - [设计建议](#设计建议)

---

## 2.21.1 事务场景

### 常见场景

1. **数据一致性**
   - 消息发送和数据库操作
   - 多消息原子性
   - 分布式事务

2. **Exactly-Once语义**
   - 精确一次处理
   - 幂等性保证
   - 重复检测

3. **事务性消息**
   - 事务消息发送
   - 事务消息消费
   - 事务回滚

---

## 2.21.2 Kafka事务

### 事务Producer

```java
// 配置事务Producer
Properties props = new Properties();
props.put("transactional.id", "my-transactional-id");
props.put("enable.idempotence", "true");

Producer<String, String> producer = new KafkaProducer<>(props);
producer.initTransactions();

try {
    producer.beginTransaction();

    // 发送多条消息
    producer.send(new ProducerRecord<>("orders", key1, value1));
    producer.send(new ProducerRecord<>("payments", key2, value2));

    // 提交事务
    producer.commitTransaction();
} catch (Exception e) {
    // 回滚事务
    producer.abortTransaction();
}
```

### 事务Consumer

```java
// 配置事务Consumer
Properties props = new Properties();
props.put("isolation.level", "read_committed");

Consumer<String, String> consumer = new KafkaConsumer<>(props);
consumer.subscribe(Collections.singletonList("orders"));

// 只读取已提交的消息
ConsumerRecords<String, String> records = consumer.poll(Duration.ofMillis(100));
```

---

## 2.21.3 NATS事务

### 事务实现

```go
// NATS Core无原生事务支持
// 使用应用层实现事务语义

// 使用JetStream实现事务性
js, _ := nc.JetStream()

// 事务性发布
pubAck, err := js.Publish("orders", data, nats.MsgId("msg-1"))
if err != nil {
    // 回滚
    return err
}

// 确认提交
js.Publish("payments", data, nats.MsgId("msg-2"))
```

---

## 2.21.4 RabbitMQ事务

### 事务Channel

```python
# 开启事务
channel.tx_select()

try:
    # 发送多条消息
    channel.basic_publish(exchange='orders', routing_key='', body=msg1)
    channel.basic_publish(exchange='payments', routing_key='', body=msg2)

    # 提交事务
    channel.tx_commit()
except Exception as e:
    # 回滚事务
    channel.tx_rollback()
```

### 发布确认

```python
# 使用发布确认替代事务（性能更好）
channel.confirm_delivery()

def handle_confirmed(frame):
    print("Message confirmed")

channel.add_on_return_callback(handle_confirmed)
channel.basic_publish(exchange='orders', routing_key='', body=msg)
```

---

## 2.21.5 事务最佳实践

### 设计建议

1. **事务选择**
   - 系统原生事务（Kafka/RabbitMQ）
   - 应用层事务（NATS）
   - 分布式事务（Saga模式）

2. **性能考虑**
   - 事务性能开销
   - 使用发布确认替代事务
   - 合理使用事务

3. **错误处理**
   - 事务回滚
   - 重试机制
   - 死信队列

---

**最后更新**: 2025-12-31
