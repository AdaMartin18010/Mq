# 2.14 消息去重策略

## 目录

- [2.14 消息去重策略](#214-消息去重策略)
  - [目录](#目录)
  - [2.14.1 去重场景](#2141-去重场景)
    - [常见场景](#常见场景)
  - [2.14.2 去重方法](#2142-去重方法)
    - [去重策略](#去重策略)
  - [2.14.3 Kafka去重](#2143-kafka去重)
    - [幂等Producer](#幂等producer)
    - [消费者去重](#消费者去重)
  - [2.14.4 NATS去重](#2144-nats去重)
    - [消息去重](#消息去重)
  - [2.14.5 RabbitMQ去重](#2145-rabbitmq去重)
    - [消息去重](#消息去重-1)
  - [2.14.6 去重最佳实践](#2146-去重最佳实践)
    - [设计建议](#设计建议)

---

## 2.14.1 去重场景

### 常见场景

1. **网络重传**
   - 网络故障导致重传
   - 需要去重处理

2. **系统重试**
   - 业务逻辑重试
   - 避免重复处理

3. **幂等性保证**
   - 确保操作幂等
   - 防止重复执行

---

## 2.14.2 去重方法

### 去重策略

1. **消息ID去重**
   - 使用唯一消息ID
   - 基于ID判断重复

2. **业务键去重**
   - 使用业务唯一键
   - 基于业务键判断

3. **时间窗口去重**
   - 时间窗口内去重
   - 过期自动清理

---

## 2.14.3 Kafka去重

### 幂等Producer

```java
// 启用幂等Producer
Properties props = new Properties();
props.put("enable.idempotence", true);
props.put("acks", "all");
props.put("retries", Integer.MAX_VALUE);

// 相同消息ID不会重复
producer.send(new ProducerRecord<>("topic", key, value));
```

### 消费者去重

```java
// 使用Redis存储已处理消息ID
Set<String> processedIds = redis.get("processed:ids");
if (!processedIds.contains(messageId)) {
    process(message);
    redis.sadd("processed:ids", messageId);
}
```

---

## 2.14.4 NATS去重

### 消息去重

```go
// 使用消息头存储唯一ID
msg := nats.NewMsg("orders")
msg.Header.Set("Message-ID", generateUUID())

// 消费者去重
processedIDs := make(map[string]bool)
if !processedIDs[msg.Header.Get("Message-ID")] {
    process(msg)
    processedIDs[msg.Header.Get("Message-ID")] = true
}
```

---

## 2.14.5 RabbitMQ去重

### 消息去重

```python
# 使用消息属性存储唯一ID
properties = pika.BasicProperties(
    message_id=str(uuid.uuid4()),
    delivery_mode=2
)
channel.basic_publish(
    exchange='',
    routing_key='orders',
    body=message,
    properties=properties
)

# 消费者去重
processed_ids = set()
if message_id not in processed_ids:
    process(message)
    processed_ids.add(message_id)
```

---

## 2.14.6 去重最佳实践

### 设计建议

1. **消息ID设计**
   - 全局唯一
   - 包含时间戳
   - 易于生成

2. **存储选择**
   - 内存：快速但易丢失
   - Redis：快速且持久
   - 数据库：可靠但较慢

3. **过期策略**
   - 设置TTL
   - 定期清理
   - 避免内存泄漏

---

**最后更新**: 2025-12-31
