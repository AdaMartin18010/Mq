# 2.36 消息缓存设计

## 目录

- [2.36 消息缓存设计](#236-消息缓存设计)
  - [目录](#目录)
  - [2.36.1 缓存场景](#2361-缓存场景)
    - [常见场景](#常见场景)
  - [2.36.2 Kafka缓存](#2362-kafka缓存)
    - [缓存实现](#缓存实现)
  - [2.36.3 NATS缓存](#2363-nats缓存)
    - [缓存实现](#缓存实现-1)
  - [2.36.4 RabbitMQ缓存](#2364-rabbitmq缓存)
    - [缓存实现](#缓存实现-2)
  - [2.36.5 缓存最佳实践](#2365-缓存最佳实践)
    - [设计建议](#设计建议)

---

## 2.36.1 缓存场景

### 常见场景

1. **消息缓存**
   - 热点消息缓存
   - 历史消息查询
   - 消息重放

2. **元数据缓存**
   - Topic/Subject/Queue元数据
   - 分区信息缓存
   - 路由信息缓存

3. **性能优化**
   - 减少网络请求
   - 降低延迟
   - 提高吞吐量

---

## 2.36.2 Kafka缓存

### 缓存实现

```java
// 消息缓存
// 使用本地缓存缓存热点消息
Cache<String, String> messageCache = Caffeine.newBuilder()
    .maximumSize(10000)
    .expireAfterWrite(5, TimeUnit.MINUTES)
    .build();

// 缓存消息
ProducerRecord<String, String> record = new ProducerRecord<>("orders", key, value);
messageCache.put(key, value);

// 查询缓存
String cached = messageCache.getIfPresent(key);
if (cached != null) {
    return cached;
}

// 元数据缓存
MetadataCache metadataCache = new MetadataCache();
metadataCache.cacheTopicMetadata("orders", topicMetadata);
```

---

## 2.36.3 NATS缓存

### 缓存实现

```go
// 消息缓存
var messageCache = sync.Map{}

// 缓存消息
nc.Subscribe("orders.*", func(msg *nats.Msg) {
    // 缓存消息
    messageCache.Store(msg.Subject, msg.Data)

    // 处理消息
    processMessage(msg)
})

// 查询缓存
if cached, ok := messageCache.Load(subject); ok {
    return cached.([]byte)
}

// 元数据缓存
var metadataCache = make(map[string]*nats.SubjectMetadata)
```

---

## 2.36.4 RabbitMQ缓存

### 缓存实现

```python
# 消息缓存
from cachetools import TTLCache

message_cache = TTLCache(maxsize=10000, ttl=300)  # 5分钟过期

# 缓存消息
def cache_message(key, message):
    message_cache[key] = message

# 查询缓存
def get_cached_message(key):
    return message_cache.get(key)

# 元数据缓存
metadata_cache = {}

def cache_metadata(queue_name, metadata):
    metadata_cache[queue_name] = metadata
```

---

## 2.36.5 缓存最佳实践

### 设计建议

1. **缓存策略**
   - LRU缓存
   - TTL过期
   - 缓存预热

2. **缓存一致性**
   - 缓存失效
   - 缓存更新
   - 缓存同步

3. **性能优化**
   - 缓存大小
   - 缓存命中率
   - 缓存穿透防护

---

**最后更新**: 2025-12-31
