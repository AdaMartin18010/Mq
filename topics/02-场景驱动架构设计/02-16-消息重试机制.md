# 2.16 消息重试机制

## 目录

- [2.16 消息重试机制](#216-消息重试机制)
  - [目录](#目录)
  - [2.16.1 重试策略](#2161-重试策略)
    - [重试类型](#重试类型)
  - [2.16.2 Kafka重试](#2162-kafka重试)
    - [Producer重试](#producer重试)
    - [Consumer重试](#consumer重试)
  - [2.16.3 NATS重试](#2163-nats重试)
    - [应用层重试](#应用层重试)
    - [JetStream重试](#jetstream重试)
  - [2.16.4 RabbitMQ重试](#2164-rabbitmq重试)
    - [重试机制](#重试机制)
  - [2.16.5 重试最佳实践](#2165-重试最佳实践)
    - [设计建议](#设计建议)

---

## 2.16.1 重试策略

### 重试类型

1. **固定间隔重试**
   - 固定时间间隔
   - 简单实现
   - 适用：短暂故障

2. **指数退避重试**
   - 间隔逐渐增加
   - 减少系统压力
   - 适用：持续故障

3. **自定义重试**
   - 根据业务定制
   - 灵活控制
   - 适用：特殊场景

---

## 2.16.2 Kafka重试

### Producer重试

```java
Properties props = new Properties();
props.put("retries", 3);
props.put("retry.backoff.ms", 100);
props.put("max.in.flight.requests.per.connection", 1);

// 重试配置
producer.send(record, new Callback() {
    @Override
    public void onCompletion(RecordMetadata metadata, Exception exception) {
        if (exception != null) {
            // 处理失败
        }
    }
});
```

### Consumer重试

```java
// 手动提交，失败后重试
try {
    process(record);
    consumer.commitSync();
} catch (Exception e) {
    // 记录错误，稍后重试
    retryQueue.add(record);
}
```

---

## 2.16.3 NATS重试

### 应用层重试

```go
maxRetries := 3
retryDelay := time.Second

for i := 0; i < maxRetries; i++ {
    err := processMessage(msg)
    if err == nil {
        break
    }

    if i < maxRetries-1 {
        time.Sleep(retryDelay * time.Duration(i+1))
    }
}
```

### JetStream重试

```go
// JetStream自动重试
js.Subscribe("orders", func(msg *nats.Msg) {
    if err := process(msg); err != nil {
        msg.Nak() // 否定确认，触发重试
    } else {
        msg.Ack()
    }
}, nats.MaxDeliver(3))
```

---

## 2.16.4 RabbitMQ重试

### 重试机制

```python
max_retries = 3
retry_delay = 1

def process_with_retry(channel, method, properties, body):
    for attempt in range(max_retries):
        try:
            process_message(body)
            channel.basic_ack(delivery_tag=method.delivery_tag)
            break
        except Exception as e:
            if attempt < max_retries - 1:
                time.sleep(retry_delay * (2 ** attempt))
            else:
                # 发送到死信队列
                channel.basic_nack(delivery_tag=method.delivery_tag, requeue=False)
```

---

## 2.16.5 重试最佳实践

### 设计建议

1. **重试次数**
   - 设置合理上限
   - 避免无限重试
   - 记录重试次数

2. **退避策略**
   - 使用指数退避
   - 添加随机抖动
   - 避免惊群效应

3. **失败处理**
   - 死信队列
   - 告警通知
   - 人工介入

---

**最后更新**: 2025-12-31
