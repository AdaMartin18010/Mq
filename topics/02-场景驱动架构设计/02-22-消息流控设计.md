# 2.22 消息流控设计

## 目录

- [2.22 消息流控设计](#222-消息流控设计)
  - [目录](#目录)
  - [2.22.1 流控场景](#2221-流控场景)
    - [常见场景](#常见场景)
  - [2.22.2 Kafka流控](#2222-kafka流控)
    - [Producer流控](#producer流控)
    - [Consumer流控](#consumer流控)
  - [2.22.3 NATS流控](#2223-nats流控)
    - [连接流控](#连接流控)
  - [2.22.4 RabbitMQ流控](#2224-rabbitmq流控)
    - [流控机制](#流控机制)
  - [2.22.5 流控最佳实践](#2225-流控最佳实践)
    - [设计建议](#设计建议)

---

## 2.22.1 流控场景

### 常见场景

1. **流量保护**
   - 防止系统过载
   - 保护下游服务
   - 平滑流量波动

2. **资源控制**
   - CPU使用率控制
   - 内存使用控制
   - 网络带宽控制

3. **限流策略**
   - 固定速率限流
   - 令牌桶限流
   - 滑动窗口限流

---

## 2.22.2 Kafka流控

### Producer流控

```java
// 配置Producer流控
Properties props = new Properties();
props.put("max.in.flight.requests.per.connection", 5);
props.put("buffer.memory", 33554432);
props.put("batch.size", 16384);
props.put("linger.ms", 10);

// 使用Kafka Streams限流
streamsConfiguration.put(
    StreamsConfig.MAX_TASK_IDLE_MS_CONFIG,
    5000  // 最大空闲时间
);
```

### Consumer流控

```java
// 配置Consumer流控
Properties props = new Properties();
props.put("max.poll.records", 500);
props.put("fetch.min.bytes", 1);
props.put("fetch.max.wait.ms", 500);
```

---

## 2.22.3 NATS流控

### 连接流控

```go
// 配置连接流控
opts := nats.Options{
    MaxReconnects: 10,
    ReconnectWait: time.Second * 2,
    SubChanLen:    1000,  // 订阅通道长度
}

nc, _ := nats.Connect("nats://localhost:4222", opts)

// 订阅限流
sub, _ := nc.Subscribe("orders", func(msg *nats.Msg) {
    // 处理消息
    time.Sleep(10 * time.Millisecond)  // 限流
})
```

---

## 2.22.4 RabbitMQ流控

### 流控机制

```python
# 配置流控
channel.basic_qos(
    prefetch_count=100,  # 预取数量
    prefetch_size=0,     # 预取大小
    global_=False
)

# 连接流控
connection = pika.BlockingConnection(
    pika.ConnectionParameters(
        host='localhost',
        heartbeat=600,
        blocked_connection_timeout=300
    )
)
```

---

## 2.22.5 流控最佳实践

### 设计建议

1. **流控策略**
   - 多级流控
   - 动态调整
   - 监控告警

2. **性能考虑**
   - 流控开销
   - 延迟影响
   - 吞吐量平衡

3. **监控告警**
   - 流控触发监控
   - 性能影响监控
   - 告警阈值设置

---

**最后更新**: 2025-12-31
