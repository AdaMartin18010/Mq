# 2.39 消息监控告警设计

## 目录

- [2.39 消息监控告警设计](#239-消息监控告警设计)
  - [目录](#目录)
  - [2.39.1 监控告警场景](#2391-监控告警场景)
    - [常见场景](#常见场景)
  - [2.39.2 Kafka监控告警](#2392-kafka监控告警)
    - [监控实现](#监控实现)
  - [2.39.3 NATS监控告警](#2393-nats监控告警)
    - [监控实现](#监控实现-1)
  - [2.39.4 RabbitMQ监控告警](#2394-rabbitmq监控告警)
    - [监控实现](#监控实现-2)
  - [2.39.5 监控告警最佳实践](#2395-监控告警最佳实践)
    - [设计建议](#设计建议)

---

## 2.39.1 监控告警场景

### 常见场景

1. **性能监控**
   - 吞吐量监控
   - 延迟监控
   - 资源使用监控

2. **健康监控**
   - 服务健康检查
   - 连接状态监控
   - 集群状态监控

3. **异常告警**
   - 错误率告警
   - 延迟告警
   - 资源告警

---

## 2.39.2 Kafka监控告警

### 监控实现

```java
// Prometheus指标收集
// 使用Kafka Exporter
// 配置kafka_exporter
kafka_exporter --kafka.server=localhost:9092

// 自定义指标
Counter messageCount = Counter.build()
    .name("kafka_messages_total")
    .help("Total number of messages")
    .register();

Histogram messageLatency = Histogram.build()
    .name("kafka_message_latency_seconds")
    .help("Message processing latency")
    .register();

// 告警规则
// alert_rules.yml
groups:
  - name: kafka_alerts
    rules:
      - alert: HighErrorRate
        expr: rate(kafka_errors_total[5m]) > 0.1
        for: 5m
        annotations:
          summary: "Kafka error rate is high"
```

---

## 2.39.3 NATS监控告警

### 监控实现

```go
// Prometheus指标收集
// 使用NATS Prometheus Exporter
// 配置nats_exporter
nats_exporter --nats.server=nats://localhost:4222

// 自定义指标
messageCount := prometheus.NewCounterVec(
    prometheus.CounterOpts{
        Name: "nats_messages_total",
        Help: "Total number of messages",
    },
    []string{"subject"},
)

messageLatency := prometheus.NewHistogramVec(
    prometheus.HistogramOpts{
        Name: "nats_message_latency_seconds",
        Help: "Message processing latency",
    },
    []string{"subject"},
)

// 告警规则
// alert_rules.yml
groups:
  - name: nats_alerts
    rules:
      - alert: HighErrorRate
        expr: rate(nats_errors_total[5m]) > 0.1
        for: 5m
```

---

## 2.39.4 RabbitMQ监控告警

### 监控实现

```python
# Prometheus指标收集
# 使用RabbitMQ Prometheus Exporter
# 配置rabbitmq_exporter
rabbitmq_exporter --rabbitmq.url=http://localhost:15672

# 自定义指标
message_count = Counter(
    'rabbitmq_messages_total',
    'Total number of messages',
    ['exchange', 'routing_key']
)

message_latency = Histogram(
    'rabbitmq_message_latency_seconds',
    'Message processing latency',
    ['exchange', 'routing_key']
)

# 告警规则
# alert_rules.yml
groups:
  - name: rabbitmq_alerts
    rules:
      - alert: HighErrorRate
        expr: rate(rabbitmq_errors_total[5m]) > 0.1
        for: 5m
```

---

## 2.39.5 监控告警最佳实践

### 设计建议

1. **监控指标**
   - 关键指标监控
   - 业务指标监控
   - 资源指标监控

2. **告警策略**
   - 告警级别
   - 告警阈值
   - 告警通知

3. **监控可视化**
   - Grafana仪表板
   - 实时监控
   - 历史分析

---

**最后更新**: 2025-12-31
