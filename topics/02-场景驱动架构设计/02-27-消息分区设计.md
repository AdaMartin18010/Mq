# 2.27 消息分区设计

## 目录

- [2.27 消息分区设计](#227-消息分区设计)
  - [目录](#目录)
  - [2.27.1 分区场景](#2271-分区场景)
    - [常见场景](#常见场景)
  - [2.27.2 Kafka分区](#2272-kafka分区)
    - [分区策略](#分区策略)
    - [分区数量](#分区数量)
  - [2.27.3 NATS分区](#2273-nats分区)
    - [实现方式](#实现方式)
  - [2.27.4 RabbitMQ分区](#2274-rabbitmq分区)
    - [实现方式](#实现方式-1)
  - [2.27.5 分区最佳实践](#2275-分区最佳实践)
    - [设计建议](#设计建议)

---

## 2.27.1 分区场景

### 常见场景

1. **负载均衡**
   - 消息分散
   - 并行处理
   - 提高吞吐量

2. **顺序保证**
   - 分区内顺序
   - 跨分区并行
   - 业务隔离

3. **扩展性**
   - 水平扩展
   - 分区扩容
   - 性能提升

---

## 2.27.2 Kafka分区

### 分区策略

```java
// 默认分区策略（Key Hash）
ProducerRecord<String, String> record = new ProducerRecord<>(
    "orders",
    orderId,  // Key用于分区
    orderJson
);

// 自定义分区器
public class OrderPartitioner implements Partitioner {
    @Override
    public int partition(String topic, Object key, byte[] keyBytes,
                        Object value, byte[] valueBytes, Cluster cluster) {
        // 自定义分区逻辑
        return Math.abs(key.hashCode()) % cluster.partitionCountForTopic(topic);
    }
}

// 指定分区
ProducerRecord<String, String> record = new ProducerRecord<>(
    "orders",
    0,  // 指定分区0
    key,
    value
);
```

### 分区数量

```java
// 创建Topic时指定分区数
kafka-topics.sh --create \
    --topic orders \
    --partitions 6 \
    --replication-factor 3 \
    --bootstrap-server localhost:9092
```

---

## 2.27.3 NATS分区

### 实现方式

```go
// NATS Core无分区概念，使用Subject实现类似功能
// 使用Subject前缀实现分区
subject := fmt.Sprintf("orders.partition.%d", partitionID)
nc.Publish(subject, data)

// JetStream使用Stream实现分区
js.AddStream(&nats.StreamConfig{
    Name: "ORDERS",
    Subjects: []string{"orders.partition.*"},
})
```

---

## 2.27.4 RabbitMQ分区

### 实现方式

```python
# 使用多个队列实现分区
partition_count = 6
for i in range(partition_count):
    queue_name = f"orders-partition-{i}"
    channel.queue_declare(queue=queue_name, durable=True)

# 根据Key路由到不同队列
partition = hash(order_id) % partition_count
queue_name = f"orders-partition-{partition}"
channel.basic_publish(
    exchange='',
    routing_key=queue_name,
    body=message
)
```

---

## 2.27.5 分区最佳实践

### 设计建议

1. **分区设计**
   - 合理分区数量
   - 分区键选择
   - 负载均衡

2. **性能考虑**
   - 分区数量影响
   - 并行度平衡
   - 资源使用

3. **运维管理**
   - 分区监控
   - 分区扩容
   - 数据迁移

---

**最后更新**: 2025-12-31
