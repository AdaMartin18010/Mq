# 2.12 消息路由策略

## 目录

- [2.12 消息路由策略](#212-消息路由策略)
  - [目录](#目录)
  - [2.12.1 路由模式](#2121-路由模式)
    - [常见路由模式](#常见路由模式)
  - [2.12.2 Kafka路由策略](#2122-kafka路由策略)
    - [分区路由](#分区路由)
    - [路由策略](#路由策略)
  - [2.12.3 NATS路由策略](#2123-nats路由策略)
    - [Subject路由](#subject路由)
    - [路由特性](#路由特性)
  - [2.12.4 RabbitMQ路由策略](#2124-rabbitmq路由策略)
    - [Exchange路由](#exchange路由)
  - [2.12.5 路由选择指南](#2125-路由选择指南)
    - [选择建议](#选择建议)

---

## 2.12.1 路由模式

### 常见路由模式

1. **直接路由**
   - 一对一映射
   - 简单高效
   - 适用：固定路由

2. **主题路由**
   - 基于主题匹配
   - 灵活性强
   - 适用：动态路由

3. **广播路由**
   - 一对多分发
   - 消息复制
   - 适用：通知场景

---

## 2.12.2 Kafka路由策略

### 分区路由

```java
// 自定义分区器
public class CustomPartitioner implements Partitioner {
    @Override
    public int partition(String topic, Object key, byte[] keyBytes,
                        Object value, byte[] valueBytes, Cluster cluster) {
        // 根据业务逻辑选择分区
        return key.hashCode() % cluster.partitionCountForTopic(topic);
    }
}
```

### 路由策略

- **Key路由**：相同Key路由到同一分区
- **轮询路由**：无Key时轮询分配
- **自定义路由**：实现Partitioner接口

---

## 2.12.3 NATS路由策略

### Subject路由

```go
// 通配符路由
sub, _ := nc.Subscribe("orders.*.created", func(msg *nats.Msg) {
    // 处理订单创建消息
})

// 队列组路由（负载均衡）
sub, _ := nc.QueueSubscribe("orders.process", "workers", func(msg *nats.Msg) {
    // 负载均衡处理
})
```

### 路由特性

- **通配符支持**：`*`（单级）、`>`（多级）
- **队列组**：负载均衡路由
- **请求/回复**：自动路由回复

---

## 2.12.4 RabbitMQ路由策略

### Exchange路由

```python
# Direct Exchange（直接路由）
channel.exchange_declare(exchange='direct_logs', exchange_type='direct')
channel.basic_publish(exchange='direct_logs', routing_key='error', body=message)

# Topic Exchange（主题路由）
channel.exchange_declare(exchange='topic_logs', exchange_type='topic')
channel.basic_publish(exchange='topic_logs', routing_key='order.created', body=message)

# Fanout Exchange（广播路由）
channel.exchange_declare(exchange='fanout_logs', exchange_type='fanout')
channel.basic_publish(exchange='fanout_logs', routing_key='', body=message)
```

---

## 2.12.5 路由选择指南

### 选择建议

| 场景 | 推荐路由 | 系统 |
|------|---------|------|
| **固定路由** | 直接路由 | Kafka分区、RabbitMQ Direct |
| **动态路由** | 主题路由 | NATS Subject、RabbitMQ Topic |
| **广播通知** | 广播路由 | RabbitMQ Fanout、NATS Pub/Sub |
| **负载均衡** | 队列组 | NATS Queue Group、RabbitMQ Queue |

---

**最后更新**: 2025-12-31
