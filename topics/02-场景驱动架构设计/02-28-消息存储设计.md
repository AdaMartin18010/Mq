# 2.28 消息存储设计

## 目录

- [2.28 消息存储设计](#228-消息存储设计)
  - [目录](#目录)
  - [2.28.1 存储场景](#2281-存储场景)
    - [常见场景](#常见场景)
  - [2.28.2 Kafka存储](#2282-kafka存储)
    - [存储机制](#存储机制)
    - [存储优化](#存储优化)
  - [2.28.3 NATS存储](#2283-nats存储)
    - [存储机制](#存储机制-1)
  - [2.28.4 RabbitMQ存储](#2284-rabbitmq存储)
    - [存储机制](#存储机制-2)
  - [2.28.5 存储最佳实践](#2285-存储最佳实践)
    - [设计建议](#设计建议)

---

## 2.28.1 存储场景

### 常见场景

1. **持久化存储**
   - 消息持久化
   - 数据可靠性
   - 故障恢复

2. **存储优化**
   - 存储空间优化
   - 存储性能优化
   - 存储成本优化

3. **数据管理**
   - 数据保留策略
   - 数据清理策略
   - 数据归档策略

---

## 2.28.2 Kafka存储

### 存储机制

```java
// Kafka使用日志文件存储
// 配置存储保留策略
Properties props = new Properties();
props.put("log.retention.hours", 168);  // 保留7天
props.put("log.retention.bytes", 1073741824);  // 1GB
props.put("log.segment.bytes", 1073741824);  // 1GB per segment
props.put("log.cleanup.policy", "delete");  // 删除策略

// 压缩存储
props.put("compression.type", "snappy");
props.put("log.compression.type", "snappy");
```

### 存储优化

```bash
# 配置存储路径
log.dirs=/var/kafka-logs

# 配置存储保留
log.retention.hours=168
log.retention.bytes=1073741824
log.segment.bytes=1073741824
log.cleanup.policy=delete
```

---

## 2.28.3 NATS存储

### 存储机制

```go
// NATS Core无持久化存储（内存）
// JetStream提供持久化存储
js.AddStream(&nats.StreamConfig{
    Name: "ORDERS",
    Storage: nats.FileStorage,  // 文件存储
    MaxAge: 24 * time.Hour,      // 保留24小时
    MaxBytes: 1024 * 1024 * 1024, // 1GB
    MaxMsgs: 1000000,            // 100万条消息
})
```

---

## 2.28.4 RabbitMQ存储

### 存储机制

```python
# RabbitMQ消息持久化
channel.queue_declare(
    queue='orders',
    durable=True  # 队列持久化
)

channel.basic_publish(
    exchange='',
    routing_key='orders',
    body=message,
    properties=pika.BasicProperties(
        delivery_mode=2  # 消息持久化
    )
)

# 配置存储路径
# /var/lib/rabbitmq/mnesia
```

---

## 2.28.5 存储最佳实践

### 设计建议

1. **存储设计**
   - 合理保留策略
   - 存储空间规划
   - 性能优化

2. **数据管理**
   - 定期清理
   - 数据归档
   - 备份策略

3. **运维管理**
   - 存储监控
   - 容量规划
   - 成本优化

---

**最后更新**: 2025-12-31
