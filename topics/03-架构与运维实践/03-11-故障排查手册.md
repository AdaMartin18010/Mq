# 3.11 故障排查手册

## 目录

- [3.11 故障排查手册](#311-故障排查手册)
  - [目录](#目录)
  - [3.11.1 Kafka故障排查](#3111-kafka故障排查)
    - [常见问题](#常见问题)
  - [3.11.2 MQTT故障排查](#3112-mqtt故障排查)
    - [常见问题](#常见问题-1)
  - [3.11.3 NATS故障排查](#3113-nats故障排查)
    - [常见问题](#常见问题-2)
  - [3.11.4 Pulsar故障排查](#3114-pulsar故障排查)
    - [常见问题](#常见问题-3)
  - [3.11.5 通用故障排查工具](#3115-通用故障排查工具)

---

## 3.11.1 Kafka故障排查

### 常见问题

**1. Consumer Lag过高**

```bash
# 检查Consumer Lag
kafka-consumer-groups.sh --bootstrap-server localhost:9092 \
  --group my-group --describe

# 解决方案
# - 增加Consumer实例
# - 优化消费逻辑
# - 检查网络延迟
```

**2. 分区Leader不可用**

```bash
# 检查分区状态
kafka-topics.sh --bootstrap-server localhost:9092 \
  --topic my-topic --describe

# 解决方案
# - 检查Broker健康状态
# - 触发Leader选举
# - 检查副本同步状态
```

**3. 消息丢失**

```bash
# 检查Producer配置
# - acks=-1 (等待所有副本确认)
# - retries=2147483647 (无限重试)
# - enable.idempotence=true (幂等性)

# 检查Consumer配置
# - enable.auto.commit=false (手动提交)
```

---

## 3.11.2 MQTT故障排查

### 常见问题

**1. 连接失败**

```bash
# 检查Broker状态
mosquitto_sub -h localhost -t test -v

# 检查网络连接
telnet broker.example.com 1883

# 检查认证配置
mosquitto_pub -h localhost -t test -m "test" -u username -P password
```

**2. 消息未收到**

```bash
# 检查订阅
mosquitto_sub -h localhost -t sensors/+ -v

# 检查QoS级别
# - QoS 0: 最多一次，可能丢失
# - QoS 1: 至少一次，可能重复
# - QoS 2: 恰好一次，保证送达
```

---

## 3.11.3 NATS故障排查

### 常见问题

**1. 连接超时**

```bash
# 检查NATS Server状态
nats server check

# 检查集群状态
nats server info

# 检查网络连接
telnet localhost 4222
```

**2. 消息丢失（Core模式）**

```bash
# NATS Core模式不保证消息投递
# 解决方案：使用JetStream持久化模式

# 创建Stream
nats stream add my-stream --subjects "orders.*" --storage file --replicas 3
```

---

## 3.11.4 Pulsar故障排查

### 常见问题

**1. Broker不可用**

```bash
# 检查Broker状态
pulsar-admin brokers list

# 检查BookKeeper状态
pulsar-admin bookies list

# 检查ZooKeeper状态
pulsar-admin clusters list
```

**2. 消息积压**

```bash
# 检查订阅积压
pulsar-admin topics stats persistent://tenant/ns/topic

# 解决方案
# - 增加Consumer实例
# - 优化消费逻辑
# - 调整订阅模式
```

---

## 3.11.5 通用故障排查工具

**监控工具**：

- Prometheus + Grafana
- ELK Stack（日志分析）
- Jaeger（分布式追踪）

**命令行工具**：

- `kafka-topics.sh` - Kafka主题管理
- `mosquitto_sub/pub` - MQTT测试
- `nats` - NATS CLI工具
- `pulsar-admin` - Pulsar管理工具

---

**最后更新**: 2025-12-31
