# 3.14 监控配置示例

## 目录

- [3.14 监控配置示例](#314-监控配置示例)
  - [目录](#目录)
  - [3.14.1 Prometheus监控配置](#3141-prometheus监控配置)
    - [Kafka监控配置](#kafka监控配置)
    - [NATS监控配置](#nats监控配置)
    - [RabbitMQ监控配置](#rabbitmq监控配置)
  - [3.14.2 Grafana仪表板配置](#3142-grafana仪表板配置)
    - [关键指标](#关键指标)
  - [3.14.3 告警规则配置](#3143-告警规则配置)
    - [Kafka告警规则](#kafka告警规则)
    - [NATS告警规则](#nats告警规则)
  - [3.14.4 监控最佳实践](#3144-监控最佳实践)
    - [1. 指标选择](#1-指标选择)
    - [2. 告警策略](#2-告警策略)
    - [3. 监控工具](#3-监控工具)

---

## 3.14.1 Prometheus监控配置

### Kafka监控配置

```yaml
# prometheus.yml
scrape_configs:
  - job_name: 'kafka'
    static_configs:
      - targets: ['localhost:9092']
    metrics_path: '/metrics'
```

### NATS监控配置

```yaml
scrape_configs:
  - job_name: 'nats'
    static_configs:
      - targets: ['localhost:8222']
    metrics_path: '/varz'
```

### RabbitMQ监控配置

```yaml
scrape_configs:
  - job_name: 'rabbitmq'
    static_configs:
      - targets: ['localhost:15692']
    metrics_path: '/metrics'
```

---

## 3.14.2 Grafana仪表板配置

### 关键指标

1. **吞吐量指标**
   - Producer/Consumer TPS
   - 消息速率

2. **延迟指标**
   - P50/P95/P99延迟
   - 端到端延迟

3. **资源指标**
   - CPU使用率
   - 内存使用率
   - 磁盘IO

4. **健康指标**
   - 连接数
   - 错误率
   - 副本状态

---

## 3.14.3 告警规则配置

### Kafka告警规则

```yaml
groups:
  - name: kafka_alerts
    rules:
      - alert: KafkaHighConsumerLag
        expr: kafka_consumer_lag_sum > 100000
        for: 5m
        annotations:
          summary: "Kafka Consumer Lag过高"

      - alert: KafkaUnderReplicatedPartitions
        expr: kafka_controller_offline_partitions_count > 0
        for: 1m
        annotations:
          summary: "Kafka分区副本不足"
```

### NATS告警规则

```yaml
groups:
  - name: nats_alerts
    rules:
      - alert: NATSHighConnections
        expr: nats_connz_connections > 10000
        for: 5m
        annotations:
          summary: "NATS连接数过高"
```

---

## 3.14.4 监控最佳实践

### 1. 指标选择

- **核心指标**：吞吐量、延迟、错误率
- **资源指标**：CPU、内存、磁盘、网络
- **业务指标**：消息积压、处理速率

### 2. 告警策略

- **严重告警**：立即通知（错误率>1%）
- **警告告警**：延迟通知（延迟>阈值）
- **信息告警**：记录日志（资源使用>80%）

### 3. 监控工具

- **Prometheus**：指标收集
- **Grafana**：可视化
- **AlertManager**：告警管理

---

**最后更新**: 2025-12-31
