# 3.19 故障恢复演练

## 目录

- [3.19 故障恢复演练](#319-故障恢复演练)
  - [目录](#目录)
  - [3.19.1 演练场景](#3191-演练场景)
    - [常见故障场景](#常见故障场景)
  - [3.19.2 Kafka故障恢复](#3192-kafka故障恢复)
    - [场景1：Broker节点故障](#场景1broker节点故障)
  - [3.19.3 NATS故障恢复](#3193-nats故障恢复)
    - [场景1：Server节点故障](#场景1server节点故障)
  - [3.19.4 RabbitMQ故障恢复](#3194-rabbitmq故障恢复)
    - [场景1：节点故障](#场景1节点故障)
  - [3.19.5 演练检查清单](#3195-演练检查清单)
    - [演练前准备](#演练前准备)
    - [演练过程](#演练过程)
    - [演练后总结](#演练后总结)

---

## 3.19.1 演练场景

### 常见故障场景

1. **节点故障**
   - Broker/Server节点宕机
   - 网络分区

2. **数据故障**
   - 数据损坏
   - 磁盘故障

3. **性能故障**
   - 消息积压
   - 高延迟

---

## 3.19.2 Kafka故障恢复

### 场景1：Broker节点故障

**演练步骤**：

1. **模拟故障**

   ```bash
   # 停止Broker 2
   pkill -f "kafka.Kafka.*broker.id=2"
   ```

2. **检查影响**

   ```bash
   # 检查分区状态
   kafka-topics.sh --describe --topic test-topic \
     --bootstrap-server localhost:9092
   ```

3. **恢复操作**

   ```bash
   # 重启Broker
   ./scripts/restart.sh kafka
   ```

4. **验证恢复**

   ```bash
   # 检查ISR状态
   kafka-topics.sh --describe --topic test-topic \
     --bootstrap-server localhost:9092 | grep Isr
   ```

---

## 3.19.3 NATS故障恢复

### 场景1：Server节点故障

**演练步骤**：

1. **模拟故障**

   ```bash
   # 停止NATS Server
   pkill -f nats-server
   ```

2. **检查影响**

   ```bash
   # 检查连接状态
   curl http://localhost:8222/varz
   ```

3. **恢复操作**

   ```bash
   # 重启NATS
   ./scripts/restart.sh nats
   ```

4. **验证恢复**

   ```bash
   # 检查服务状态
   ./scripts/health-check.sh nats
   ```

---

## 3.19.4 RabbitMQ故障恢复

### 场景1：节点故障

**演练步骤**：

1. **模拟故障**

   ```bash
   # 停止RabbitMQ节点
   docker stop rabbitmq
   ```

2. **检查影响**

   ```bash
   # 检查队列状态
   rabbitmqctl list_queues
   ```

3. **恢复操作**

   ```bash
   # 重启RabbitMQ
   ./scripts/restart.sh rabbitmq
   ```

4. **验证恢复**

   ```bash
   # 检查集群状态
   rabbitmqctl cluster_status
   ```

---

## 3.19.5 演练检查清单

### 演练前准备

- [ ] 备份所有数据
- [ ] 准备回滚方案
- [ ] 通知相关人员
- [ ] 准备监控工具

### 演练过程

- [ ] 记录故障时间
- [ ] 记录恢复时间
- [ ] 记录影响范围
- [ ] 记录恢复步骤

### 演练后总结

- [ ] 分析故障原因
- [ ] 评估恢复时间
- [ ] 优化恢复流程
- [ ] 更新文档

---

**最后更新**: 2025-12-31
