# 3.15 消息队列迁移指南

## 目录

- [3.15 消息队列迁移指南](#315-消息队列迁移指南)
  - [目录](#目录)
  - [3.15.1 迁移策略](#3151-迁移策略)
    - [迁移类型](#迁移类型)
    - [迁移方法](#迁移方法)
  - [3.15.2 Kafka迁移](#3152-kafka迁移)
    - [Kafka ZooKeeper → KRaft迁移](#kafka-zookeeper--kraft迁移)
  - [3.15.3 系统间迁移](#3153-系统间迁移)
    - [RabbitMQ → Kafka迁移](#rabbitmq--kafka迁移)
  - [3.15.4 迁移最佳实践](#3154-迁移最佳实践)
    - [1. 迁移前准备](#1-迁移前准备)
    - [2. 迁移过程](#2-迁移过程)
    - [3. 迁移后验证](#3-迁移后验证)

---

## 3.15.1 迁移策略

### 迁移类型

1. **版本升级迁移**
   - Kafka 2.x → 3.x（KRaft模式）
   - MQTT 3.1.1 → 5.0

2. **系统间迁移**
   - RabbitMQ → Kafka
   - Kafka → Pulsar
   - 传统MQ → 云服务

3. **架构迁移**
   - 单机 → 集群
   - 传统部署 → Kubernetes

### 迁移方法

1. **双写策略**：新旧系统同时写入
2. **逐步迁移**：按Topic/Queue逐步迁移
3. **一次性迁移**：停机迁移

---

## 3.15.2 Kafka迁移

### Kafka ZooKeeper → KRaft迁移

**步骤**：

1. **准备阶段**

   ```bash
   # 备份配置和数据
   cp -r kafka-logs kafka-logs-backup
   ```

2. **迁移阶段**

   ```bash
   # 使用kafka-metadata-migration工具
   kafka-metadata-migration.sh --bootstrap-server localhost:9092 \
     --zookeeper localhost:2181 \
     --migrate
   ```

3. **验证阶段**

   ```bash
   # 验证数据完整性
   kafka-console-consumer.sh --topic test-topic \
     --from-beginning --bootstrap-server localhost:9092
   ```

---

## 3.15.3 系统间迁移

### RabbitMQ → Kafka迁移

**步骤**：

1. **数据导出**

   ```python
   # 从RabbitMQ导出消息
   import pika
   channel = pika.BlockingConnection(...).channel()
   method, properties, body = channel.basic_get(queue='orders')
   ```

2. **数据导入**

   ```python
   # 导入到Kafka
   from kafka import KafkaProducer
   producer = KafkaProducer(bootstrap_servers='localhost:9092')
   producer.send('orders', body)
   ```

3. **双写过渡期**
   - 同时写入RabbitMQ和Kafka
   - 逐步切换Consumer到Kafka
   - 验证数据一致性

---

## 3.15.4 迁移最佳实践

### 1. 迁移前准备

- ✅ 备份所有数据
- ✅ 制定回滚计划
- ✅ 准备监控和告警
- ✅ 进行小规模测试

### 2. 迁移过程

- ✅ 使用双写策略
- ✅ 逐步迁移，不要一次性切换
- ✅ 实时监控数据一致性
- ✅ 保持旧系统运行一段时间

### 3. 迁移后验证

- ✅ 验证数据完整性
- ✅ 验证性能指标
- ✅ 验证功能正确性
- ✅ 监控运行状态

---

**最后更新**: 2025-12-31
