# 3.16 安全加固指南

## 目录

- [3.16 安全加固指南](#316-安全加固指南)
  - [目录](#目录)
  - [3.16.1 安全加固检查清单](#3161-安全加固检查清单)
    - [通用安全检查](#通用安全检查)
  - [3.16.2 Kafka安全加固](#3162-kafka安全加固)
    - [1. 启用SASL认证](#1-启用sasl认证)
    - [2. 启用SSL加密](#2-启用ssl加密)
    - [3. 配置ACL授权](#3-配置acl授权)
  - [3.16.3 MQTT安全加固](#3163-mqtt安全加固)
    - [1. 启用TLS加密](#1-启用tls加密)
    - [2. 配置用户名密码](#2-配置用户名密码)
    - [3. 配置主题权限](#3-配置主题权限)
  - [3.16.4 NATS安全加固](#3164-nats安全加固)
    - [1. 启用TLS加密](#1-启用tls加密-1)
    - [2. 配置认证](#2-配置认证)
  - [3.16.5 RabbitMQ安全加固](#3165-rabbitmq安全加固)
    - [1. 启用TLS加密](#1-启用tls加密-2)
    - [2. 配置用户权限](#2-配置用户权限)
  - [3.16.6 安全监控](#3166-安全监控)
    - [监控指标](#监控指标)
    - [告警规则](#告警规则)

---

## 3.16.1 安全加固检查清单

### 通用安全检查

- [ ] 启用TLS/SSL加密
- [ ] 配置认证机制（SASL/用户名密码）
- [ ] 配置授权策略（ACL）
- [ ] 限制网络访问（防火墙规则）
- [ ] 定期更新软件版本
- [ ] 启用审计日志
- [ ] 配置安全组和网络隔离

---

## 3.16.2 Kafka安全加固

### 1. 启用SASL认证

```properties
# server.properties
security.inter.broker.protocol=SASL_SSL
sasl.mechanism.inter.broker.protocol=PLAIN
sasl.enabled.mechanisms=PLAIN

# 配置用户
listeners=SASL_PLAINTEXT://localhost:9092
```

### 2. 启用SSL加密

```properties
ssl.keystore.location=/var/private/ssl/kafka.server.keystore.jks
ssl.keystore.password=test1234
ssl.truststore.location=/var/private/ssl/kafka.server.truststore.jks
ssl.truststore.password=test1234
```

### 3. 配置ACL授权

```bash
# 创建ACL规则
kafka-acls.sh --authorizer-properties zookeeper.connect=localhost:2181 \
  --add --allow-principal User:producer \
  --operation Write --topic test-topic
```

---

## 3.16.3 MQTT安全加固

### 1. 启用TLS加密

```conf
# mosquitto.conf
listener 8883
cafile /etc/mosquitto/ca_certificates/ca.crt
certfile /etc/mosquitto/certs/server.crt
keyfile /etc/mosquitto/certs/server.key
require_certificate true
```

### 2. 配置用户名密码

```conf
password_file /etc/mosquitto/passwd
allow_anonymous false
```

### 3. 配置主题权限

```conf
# ACL文件
user device1
topic read sensors/device1/+
topic write sensors/device1/+

user device2
topic read sensors/device2/+
topic write sensors/device2/+
```

---

## 3.16.4 NATS安全加固

### 1. 启用TLS加密

```conf
# nats-server.conf
tls {
  cert_file: "/path/to/server.crt"
  key_file: "/path/to/server.key"
  ca_file: "/path/to/ca.crt"
}
```

### 2. 配置认证

```conf
authorization {
  users = [
    {user: "admin", password: "$2a$11$..."}
  ]
}
```

---

## 3.16.5 RabbitMQ安全加固

### 1. 启用TLS加密

```conf
# rabbitmq.conf
listeners.ssl.default = 5671
ssl_options.cacertfile = /path/to/ca_certificate.pem
ssl_options.certfile = /path/to/server_certificate.pem
ssl_options.keyfile = /path/to/server_key.pem
```

### 2. 配置用户权限

```bash
# 创建用户
rabbitmqctl add_user admin secure_password

# 设置权限
rabbitmqctl set_permissions -p / admin ".*" ".*" ".*"
```

---

## 3.16.6 安全监控

### 监控指标

1. **认证失败次数**
2. **授权拒绝次数**
3. **异常连接尝试**
4. **SSL/TLS握手失败**

### 告警规则

```yaml
- alert: HighAuthFailures
  expr: rate(mq_auth_failures_total[5m]) > 10
  for: 5m
  annotations:
    summary: "认证失败率过高"
```

---

**最后更新**: 2025-12-31
