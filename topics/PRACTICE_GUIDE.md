# 消息队列实践指南

## 目录

- [消息队列实践指南](#消息队列实践指南)
  - [目录](#目录)
  - [1. 技术选型实践指南](#1-技术选型实践指南)
    - [1.1 需求分析清单](#11-需求分析清单)
    - [1.2 选型决策流程](#12-选型决策流程)
    - [1.3 选型决策矩阵模板](#13-选型决策矩阵模板)
  - [2. 架构设计实践指南](#2-架构设计实践指南)
    - [2.1 Kafka架构设计检查清单](#21-kafka架构设计检查清单)
    - [2.2 MQTT架构设计检查清单](#22-mqtt架构设计检查清单)
    - [2.3 NATS架构设计检查清单](#23-nats架构设计检查清单)
  - [3. 部署实施实践指南](#3-部署实施实践指南)
    - [3.1 Kafka部署检查清单](#31-kafka部署检查清单)
    - [3.2 MQTT部署检查清单](#32-mqtt部署检查清单)
    - [3.3 NATS部署检查清单](#33-nats部署检查清单)
  - [4. 运维管理实践指南](#4-运维管理实践指南)
    - [4.1 日常运维检查清单](#41-日常运维检查清单)
    - [4.2 监控告警配置](#42-监控告警配置)
      - [Kafka监控指标](#kafka监控指标)
      - [MQTT监控指标](#mqtt监控指标)
      - [NATS监控指标](#nats监控指标)
  - [5. 故障处理实践指南](#5-故障处理实践指南)
    - [5.1 故障处理流程](#51-故障处理流程)
    - [5.2 常见故障处理手册](#52-常见故障处理手册)
      - [Kafka常见故障](#kafka常见故障)
      - [MQTT常见故障](#mqtt常见故障)
      - [NATS常见故障](#nats常见故障)
    - [5.3 应急预案模板](#53-应急预案模板)

---

## 1. 技术选型实践指南

### 1.1 需求分析清单

在技术选型前，请明确以下需求：

```markdown
## 业务需求
- [ ] 消息吞吐量要求（TPS）
- [ ] 延迟要求（P99延迟）
- [ ] 数据持久化要求（是/否，保留时间）
- [ ] 消息顺序性要求（全局有序/分区有序/无序）
- [ ] 投递语义要求（最多一次/至少一次/恰好一次）

## 技术需求
- [ ] 协议兼容性要求（MQTT/Kafka/NATS）
- [ ] 与现有系统集成需求
- [ ] 多语言SDK支持需求
- [ ] 事务支持需求

## 运维需求
- [ ] 团队技能水平
- [ ] 运维人力预算
- [ ] 基础设施预算
- [ ] 故障恢复时间要求（RTO）
- [ ] 数据恢复点要求（RPO）

## 场景特征
- [ ] 应用场景类型（日志/IoT/微服务/其他）
- [ ] 设备类型和数量
- [ ] 网络环境（稳定/不稳定）
- [ ] 资源限制（边缘设备/云服务器）
```

### 1.2 选型决策流程

```text
步骤1: 需求收集
    ↓
步骤2: 场景识别
    ├─ 日志聚合 → Kafka
    ├─ IoT设备 → MQTT
    ├─ 微服务 → NATS
    └─ 混合场景 → 多协议方案
    ↓
步骤3: 技术评估
    ├─ 性能指标对比
    ├─ 功能特性对比
    └─ 生态成熟度评估
    ↓
步骤4: 成本分析
    ├─ 基础设施成本
    ├─ 人力成本
    └─ 运维成本
    ↓
步骤5: 风险评估
    ├─ 技术风险
    ├─ 运维风险
    └─ 业务风险
    ↓
步骤6: 最终决策
```

### 1.3 选型决策矩阵模板

| 评估维度 | 权重 | Kafka | MQTT | NATS Core | NATS JetStream | 得分 |
|----------|------|-------|------|-----------|----------------|------|
| **性能** | 30% | 8 | 6 | 10 | 8 | |
| **功能** | 20% | 10 | 7 | 6 | 9 | |
| **运维** | 25% | 5 | 7 | 10 | 8 | |
| **生态** | 15% | 10 | 8 | 7 | 7 | |
| **成本** | 10% | 5 | 7 | 10 | 8 | |
| **总分** | 100% | | | | | |

**使用方法**：

1. 根据业务需求设置权重
2. 对每个技术打分（1-10分）
3. 计算加权总分
4. 选择得分最高的方案

## 2. 架构设计实践指南

### 2.1 Kafka架构设计检查清单

```markdown
## Topic设计
- [ ] Topic命名规范（业务.模块.操作）
- [ ] 分区数规划（考虑未来扩展）
- [ ] 副本因子设置（replication.factor=3）
- [ ] 保留策略设置（时间/大小）

## Producer设计
- [ ] 分区策略选择（Hash/RoundRobin/自定义）
- [ ] ACK级别设置（0/1/-1）
- [ ] 批量发送配置（batch.size, linger.ms）
- [ ] 压缩算法选择（snappy/gzip/lz4/zstd）
- [ ] 幂等性启用（enable.idempotence=true）

## Consumer设计
- [ ] Consumer Group命名规范
- [ ] 消费模式选择（自动提交/手动提交）
- [ ] 并发消费配置（线程数/分区数）
- [ ] 错误处理策略（重试/DLQ）
- [ ] 消费延迟监控（ConsumerLag）

## 集群设计
- [ ] Broker数量规划（至少3个）
- [ ] ZooKeeper集群配置（3/5节点）
- [ ] 跨机架部署（提高可用性）
- [ ] 磁盘规划（独立磁盘，避免IO竞争）
```

### 2.2 MQTT架构设计检查清单

```markdown
## Broker设计
- [ ] Broker选型（EMQX/Mosquitto/HiveMQ）
- [ ] 集群模式选择（主从/集群）
- [ ] 共享存储配置（NFS/Ceph）
- [ ] 连接数限制（max_connections）
- [ ] 消息大小限制（max_packet_size）

## Topic设计
- [ ] 主题命名规范（层级结构）
- [ ] 主题层级深度（建议<5层）
- [ ] 通配符使用规范（+/#）
- [ ] 主题权限控制（ACL）

## QoS策略
- [ ] QoS级别选择（0/1/2）
- [ ] 传感器数据（QoS 0）
- [ ] 控制指令（QoS 1）
- [ ] 关键操作（QoS 2）

## 设备管理
- [ ] 设备认证方式（Username/Password/证书）
- [ ] 会话持久化策略（Clean Session）
- [ ] 遗嘱消息配置（LWT）
- [ ] 心跳间隔设置（KeepAlive）
```

### 2.3 NATS架构设计检查清单

```markdown
## Server设计
- [ ] 运行模式选择（Core/JetStream）
- [ ] 集群节点数（至少3个）
- [ ] 网络配置（cluster.routes）
- [ ] 资源限制（max_connections, max_memory）

## Subject设计
- [ ] Subject命名规范（点分隔）
- [ ] 通配符使用（*单层, >多层）
- [ ] 队列组配置（负载均衡）
- [ ] 请求-响应模式（Reply Subject）

## JetStream配置
- [ ] Stream创建（主题映射）
- [ ] Consumer配置（Pull/Push模式）
- [ ] 保留策略（时间/大小/工作队列）
- [ ] 存储配置（文件/S3）
- [ ] Raft集群配置（存储组）
```

## 3. 部署实施实践指南

### 3.1 Kafka部署检查清单

```markdown
## 基础设施准备
- [ ] 服务器资源（3+节点，8核32GB+SSD）
- [ ] 网络配置（延迟<5ms，带宽充足）
- [ ] 磁盘规划（独立磁盘，RAID1）
- [ ] ZooKeeper集群部署（3/5节点）

## 配置文件
- [ ] server.properties配置
- [ ] log4j.properties配置
- [ ] JVM参数调优（堆内存、GC）
- [ ] 系统参数优化（ulimit、vm.swappiness）

## 安全配置
- [ ] SASL认证配置
- [ ] SSL/TLS加密配置
- [ ] ACL权限配置
- [ ] 审计日志配置

## 监控配置
- [ ] JMX监控配置
- [ ] Prometheus Exporter配置
- [ ] 告警规则配置
- [ ] 仪表板配置（Grafana）
```

### 3.2 MQTT部署检查清单

```markdown
## 基础设施准备
- [ ] 服务器资源（2+节点，4核16GB）
- [ ] 负载均衡器配置（HAProxy/LVS）
- [ ] 共享存储配置（NFS/Ceph）
- [ ] 网络配置（公网IP/内网）

## Broker配置
- [ ] 主从模式配置
- [ ] 会话存储配置
- [ ] 消息存储配置
- [ ] 连接池配置

## 安全配置
- [ ] 认证配置（Username/Password/证书）
- [ ] ACL权限配置
- [ ] TLS/SSL配置
- [ ] 防火墙规则

## 监控配置
- [ ] Broker监控指标
- [ ] 连接数监控
- [ ] 消息吞吐量监控
- [ ] 告警配置
```

### 3.3 NATS部署检查清单

```markdown
## 基础设施准备
- [ ] 服务器资源（1+节点，2核4GB起步）
- [ ] 网络配置（集群节点互通）
- [ ] 存储配置（JetStream模式需要）

## Server配置
- [ ] 单节点/集群模式选择
- [ ] 集群路由配置（cluster.routes）
- [ ] 资源限制配置
- [ ] JetStream配置（如需要）

## 安全配置
- [ ] NKey认证配置
- [ ] JWT认证配置
- [ ] TLS配置（可选）
- [ ] 账户权限配置

## 监控配置
- [ ] HTTP监控端点配置（/varz, /connz）
- [ ] Prometheus Exporter配置
- [ ] 告警规则配置
- [ ] 仪表板配置
```

## 4. 运维管理实践指南

### 4.1 日常运维检查清单

```markdown
## 每日检查
- [ ] 集群健康状态
- [ ] 消息积压情况（ConsumerLag）
- [ ] 磁盘使用率
- [ ] 网络延迟
- [ ] 错误日志检查

## 每周检查
- [ ] 性能指标趋势分析
- [ ] 容量规划评估
- [ ] 备份验证
- [ ] 安全审计
- [ ] 配置优化评估

## 每月检查
- [ ] 成本分析
- [ ] 容量扩展评估
- [ ] 版本更新评估
- [ ] 故障演练
- [ ] 文档更新
```

### 4.2 监控告警配置

#### Kafka监控指标

```yaml
critical_alerts:
  - name: UnderReplicatedPartitions
    threshold: ">0"
    action: "检查Broker状态和磁盘空间"

  - name: ConsumerLag
    threshold: ">10000"
    action: "增加Consumer实例或优化消费逻辑"

  - name: ActiveControllerCount
    threshold: "!=1"
    action: "检查ZooKeeper连通性"

warning_alerts:
  - name: DiskUsage
    threshold: ">70%"
    action: "清理旧日志或扩容磁盘"

  - name: NetworkLatency
    threshold: ">50ms"
    action: "检查网络状况"
```

#### MQTT监控指标

```yaml
critical_alerts:
  - name: ConnectedClients
    threshold: ">80% max_connections"
    action: "增加Broker节点"

  - name: MessageDropRate
    threshold: ">0.1%"
    action: "检查QoS配置和存储空间"

warning_alerts:
  - name: KeepAliveTimeout
    threshold: ">5%"
    action: "调整keepalive间隔"
```

#### NATS监控指标

```yaml
critical_alerts:
  - name: Routes
    threshold: "<expected_nodes-1"
    action: "检查网络分区或节点宕机"

  - name: SlowConsumers
    threshold: ">10"
    action: "优化消费者或调整max_pending_msgs"

warning_alerts:
  - name: MemoryUsage
    threshold: ">80%"
    action: "限制连接数或增加节点"
```

## 5. 故障处理实践指南

### 5.1 故障处理流程

```
故障发现
    ↓
故障确认
    ├─ 检查监控告警
    ├─ 查看错误日志
    └─ 验证故障影响范围
    ↓
故障定位
    ├─ 分析故障现象
    ├─ 检查系统状态
    └─ 定位根本原因
    ↓
故障恢复
    ├─ 执行恢复步骤
    ├─ 验证恢复效果
    └─ 监控系统状态
    ↓
故障总结
    ├─ 记录故障详情
    ├─ 分析根本原因
    ├─ 制定改进措施
    └─ 更新应急预案
```

### 5.2 常见故障处理手册

#### Kafka常见故障

**故障1: UnderReplicatedPartitions**

```markdown
症状: 分区副本数不足
原因: Broker宕机、网络分区、磁盘故障
处理步骤:
1. 检查Broker存活状态
2. 检查磁盘空间和IO
3. 检查网络连通性
4. 等待副本同步或手动触发同步
预防措施:
- 增加副本因子
- 跨机架部署
- 监控磁盘使用率
```

**故障2: Consumer Lag过高**

```markdown
症状: 消费延迟持续增长
原因: Consumer处理慢、Consumer数量不足、消息积压
处理步骤:
1. 增加Consumer实例
2. 优化消费逻辑
3. 检查Consumer性能
4. 考虑增加分区数
预防措施:
- 容量规划
- 性能测试
- 监控ConsumerLag
```

#### MQTT常见故障

**故障1: 设备重连风暴**

```markdown
症状: Broker CPU 100%，新连接被拒绝
原因: 网络抖动、设备批量重连
处理步骤:
1. 限制连接速率
2. 扩容Broker
3. 清理僵尸会话
4. 设备端随机化重连间隔
预防措施:
- 设备端指数退避重连
- 连接限流配置
- 监控连接数
```

**故障2: 主题订阅爆炸**

```markdown
症状: Broker内存溢出
原因: 主题数量过多、通配符订阅过多
处理步骤:
1. 重启Broker
2. 限制主题数量
3. 清理无效订阅
4. 优化主题设计
预防措施:
- 主题白名单策略
- 监控订阅数阈值
- 定期主题治理
```

#### NATS常见故障

**故障1: 节点故障**

```markdown
症状: 部分客户端连接断开
原因: 节点硬件故障、网络问题
处理步骤:
1. 客户端自动重连（无需操作）
2. 检查节点状态
3. 修复或替换故障节点
4. 验证集群状态
预防措施:
- 多节点部署
- 监控节点健康
- 定期故障演练
```

**故障2: 慢消费者**

```markdown
症状: 消息投递延迟
原因: Consumer处理慢、资源不足
处理步骤:
1. 监控SlowConsumers指标
2. 优化Consumer处理逻辑
3. 增加Consumer资源
4. 设置max_pending_msgs限制
预防措施:
- 性能测试
- 资源监控
- 自动断开慢消费者
```

### 5.3 应急预案模板

```markdown
## 应急预案：[故障场景名称]

### 故障描述
[描述故障现象和影响]

### 影响范围
- 影响系统：[系统名称]
- 影响用户：[用户数量/比例]
- 业务影响：[业务影响描述]

### 处理步骤
1. [步骤1]
2. [步骤2]
3. [步骤3]

### 回滚方案
[如果恢复失败的回滚步骤]

### 联系人
- 负责人：[姓名/联系方式]
- 技术支持：[联系方式]
- 业务方：[联系方式]

### 更新记录
- [日期] [更新内容]
```

---

**参考文档**:

- [部署架构模式矩阵](./03-架构与运维实践/03-01-部署架构模式矩阵.md)
- [故障场景与恢复策略](./03-架构与运维实践/03-03-故障场景与恢复策略.md)
- [场景化架构与运维决策框架](./03-架构与运维实践/03-04-场景化架构与运维决策框架.md)
