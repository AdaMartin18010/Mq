# 1.2 思维导图架构设计

## 目录

- [1.2 思维导图架构设计](#12-思维导图架构设计)
  - [目录](#目录)
  - [1.2.1 Kafka架构思维导图](#121-kafka架构思维导图)
  - [1.2.2 MQTT架构思维导图](#122-mqtt架构思维导图)
  - [1.2.3 NATS架构思维导图](#123-nats架构思维导图)
  - [1.2.4 Pulsar架构思维导图](#124-pulsar架构思维导图)
  - [1.2.5 架构设计原则](#125-架构设计原则)
    - [Kafka设计原则](#kafka设计原则)
    - [MQTT设计原则](#mqtt设计原则)
    - [NATS设计原则](#nats设计原则)
    - [Pulsar设计原则](#pulsar设计原则)
  - [1.2.6 架构设计参考资源](#126-架构设计参考资源)
    - [Kafka架构参考](#kafka架构参考)
    - [MQTT架构参考](#mqtt架构参考)
    - [NATS架构参考](#nats架构参考)
    - [Pulsar架构参考](#pulsar架构参考)

---

## 1.2.1 Kafka架构思维导图

```text
Kafka分布式流平台
├── 核心组件层
│   ├── Producer：消息生产者，采用Push模式
│   ├── Broker：消息代理，存储Partition
│   ├── Consumer：消息消费者，采用Pull模式
│   ├── Topic：逻辑消息分类
│   ├── Partition：物理分片+并行单元
│   └── ZooKeeper：元数据管理与协调
├── 算法层
│   ├── 分区算法：Hash/Random/RoundRobin
│   ├── 副本算法：Leader选举+ISR管理
│   ├── 同步算法：ACK机制(0/1/-1)
│   ├── 存储算法：顺序写+页缓存+Segment索引
│   └── 消费算法：Rebalance+Offset管理
├── 数据流层
│   ├── 生产者→Broker：批量发送+压缩
│   ├── Broker内部：Leader-Follower复制
│   └── Broker→消费者：长轮询+批量拉取
└── 可靠性层
    ├── 副本机制：AR=ISR+OSR
    ├── 故障转移：Controller选举
    └── 数据保证：至少一次/精确一次
```

## 1.2.2 MQTT架构思维导图

```text
MQTT消息队列
├── 角色层
│   ├── Publisher：消息发布者
│   ├── Broker：消息代理(服务器)
│   └── Subscriber：消息订阅者
├── 协议层
│   ├── 连接协议：TCP/TLS/WebSocket
│   ├── 消息格式：Topic+Payload
│   └── 控制报文：CONNECT/PUBLISH/SUBSCRIBE
├── 功能层
│   ├── QoS级别：0(最多一次)/1(至少一次)/2(恰好一次)
│   ├── 会话机制：Clean Session/持久会话
│   ├── 保留消息：Last Value Cache
│   └── 遗嘱机制：LWT(Last Will Testament)
├── 路由层
│   ├── 主题树：层级结构(/)
│   ├── 通配符：+(单层)/#(多层)
│   └── 订阅匹配：基于主题树的匹配算法
└── 应用层
    ├── IoT设备通信
    ├── 移动推送
    └── 实时数据监控
```

## 1.2.3 NATS架构思维导图

```text
NATS消息系统
├── 核心模式
│   ├── Core NATS：轻量级内存消息
│   └── JetStream：持久化流处理
├── 通信模式
│   ├── 发布-订阅(Pub/Sub)
│   ├── 请求-响应(Request/Reply)
│   └── 队列组(Queue Groups)
├── 架构组件
│   ├── Server：单二进制，无状态
│   ├── Client：多语言SDK
│   ├── Router：集群路由
│   └── Gateway：超级集群
├── 算法设计
│   ├── 路由算法：基于Subject的通配符匹配
│   ├── 集群算法：Gossip协议自动发现
│   └── 共识算法：Raft(JetStream)
├── 数据层
│   ├── Core：纯内存，无持久化
│   └── JetStream：文件存储+WAL+快照
└── 生态层
    ├── Connectors：数据桥接
    ├── CLI：natsCLI管理工具
    └── Observability：监控指标
```

## 1.2.4 架构设计原则

### Kafka设计原则

1. **日志即消息**：将消息视为追加日志，实现顺序写优化
2. **分区并行**：通过Partition实现水平扩展，吞吐量与分区数线性相关
3. **拉模式消费**：Consumer主动拉取，控制消费速率，避免过载
4. **零拷贝传输**：利用sendfile系统调用，减少数据拷贝

### MQTT设计原则

1. **主题命名空间**：层次化主题支持灵活订阅
2. **QoS分级**：提供不同可靠性保证，适应网络环境
3. **会话持久化**：支持断线重连后的消息恢复
4. **轻量头部**：固定头仅2字节，适合IoT低带宽

### NATS设计原则

1. **简单性优先**：文本协议易于调试，单一二进制部署
2. **无中心化**：所有节点对等，无主从之分，自愈集群
3. **双重模式**：Core模式极致性能，JetStream模式提供持久化
4. **多租户隔离**：Accounts和Streams实现资源隔离

## 1.2.5 架构设计参考资源

### Kafka架构参考

- **官方文档**: [Kafka Architecture](https://kafka.apache.org/documentation/#design)
- **设计理念**: [The Log: What every software engineer should know](https://engineering.linkedin.com/distributed-systems/log-what-every-software-engineer-should-know-about-real-time-datas-unifying)
- **存储设计**: [Kafka Storage](https://kafka.apache.org/documentation/#storage)
- **副本机制**: [Kafka Replication](https://kafka.apache.org/documentation/#replication)

### MQTT架构参考

- **OASIS标准**: [MQTT 5.0 Specification](https://docs.oasis-open.org/mqtt/mqtt/v5.0/mqtt-v5.0.html)
- **协议设计**: [MQTT Protocol](https://docs.oasis-open.org/mqtt/mqtt/v5.0/mqtt-v5.0.html#_Toc3901024)
- **QoS机制**: [MQTT QoS Levels](https://docs.oasis-open.org/mqtt/mqtt/v5.0/mqtt-v5.0.html#_Toc3901233)
- **主题设计**: [MQTT Topics](https://docs.oasis-open.org/mqtt/mqtt/v5.0/mqtt-v5.0.html#_Toc3901103)

### NATS架构参考

- **官方文档**: [NATS Architecture](https://docs.nats.io/nats-concepts/architecture)
- **集群设计**: [NATS Clustering](https://docs.nats.io/nats-concepts/clustering)
- **JetStream**: [JetStream Architecture](https://docs.nats.io/nats-concepts/jetstream)
- **CNCF资源**: [NATS in CNCF](https://landscape.cncf.io/)

---

**参考来源**:

- 基于concept01.md内容整理
- Apache Kafka官方设计文档和LinkedIn工程博客
- OASIS MQTT标准规范
- NATS CNCF官方文档
