# 1.3 决策图网分析

## 目录

- [1.3 决策图网分析](#13-决策图网分析)
  - [目录](#目录)
  - [1.3.1 消息队列选型决策树](#131-消息队列选型决策树)
  - [1.3.2 架构权衡决策网络](#132-架构权衡决策网络)
  - [1.3.3 CAP定理应用](#133-cap定理应用)
    - [Kafka (CP系统)](#kafka-cp系统)
    - [MQTT (AP系统)](#mqtt-ap系统)
    - [NATS Core (AP系统)](#nats-core-ap系统)
    - [NATS JetStream (CP系统)](#nats-jetstream-cp系统)
  - [1.3.4 决策检查清单](#134-决策检查清单)
    - [技术维度检查](#技术维度检查)
    - [运维维度检查](#运维维度检查)
    - [业务维度检查](#业务维度检查)
  - [1.3.5 决策分析参考资源](#135-决策分析参考资源)
    - [CAP定理参考](#cap定理参考)
    - [技术选型参考](#技术选型参考)
    - [决策方法论参考](#决策方法论参考)

---

## 1.3.1 消息队列选型决策树

```text
场景需求分析
├── 吞吐量优先?
│   ├── 是 → 数据规模?
│   │   ├── TB级日志流 → Kafka (100万+ TPS)
│   │   └── 百万级事件 → NATS Core (200万+ TPS)
│   └── 否 → 延迟敏感?
│       ├── 是 → 延迟要求?
│       │   ├── 微秒级 → NATS Core (30-100μs)
│       │   └── 毫秒级 → MQTT (亚毫秒)
│       └── 否 → 功能完备性?
│           ├── 高 → Kafka/RabbitMQ
│           └── 轻量 → NATS
├── 持久化要求?
│   ├── 强持久化 → Kafka (副本+磁盘) / JetStream (Raft)
│   └── 弱/无 → NATS Core (内存)
├── 协议兼容性?
│   ├── MQTT生态 → MQTT Broker
│   ├── Kafka生态 → Kafka
│   └── 多协议 → RobustMQ/NATS+bridges
├── 部署复杂度?
│   ├── 极简 → NATS (单二进制)
│   └── 可接受复杂度 → Kafka/MQTT
└── 云原生?
    ├── 边缘计算 → NATS (轻量+自愈)
    └── 数据中心 → Kafka (成熟生态)
```

## 1.3.2 架构权衡决策网络

```text
┌─────────────┐
│   设计目标   │
└──────┬──────┘
       │
       ├─→ 一致性强度 ──→ CP系统(Kafka/JetStream) vs AP系统(Core NATS)
       │
       ├─→ 可用性要求 ──→ 副本数+故障转移策略
       │
       ├─→ 性能优先级 ──→ 延迟 vs 吞吐量 vs 资源消耗
       │
       └─→ 复杂度预算 ──→ 运维成本+学习曲线

一致性-可用性权衡矩阵：
                高可用性        低可用性
强一致性     Kafka(ISR)      JetStream(Raft)
弱一致性     NATS Core       MQTT QoS0
```

## 1.3.3 CAP定理应用

### Kafka (CP系统)

- **一致性(C)**: ISR机制保证已提交消息的一致性
- **可用性(A)**: 在分区容忍的前提下，通过副本保证可用性
- **分区容忍(P)**: 支持跨机房部署，但网络分区时可能不可用

### MQTT (AP系统)

- **可用性(A)**: 主从模式保证服务可用
- **分区容忍(P)**: 支持多Broker集群
- **一致性(C)**: QoS级别决定一致性强度

### NATS Core (AP系统)

- **可用性(A)**: 全网状集群，节点故障自动切换
- **分区容忍(P)**: Gossip协议自动发现和恢复
- **一致性(C)**: 最多一次投递，不保证一致性

### NATS JetStream (CP系统)

- **一致性(C)**: Raft共识算法保证强一致性
- **可用性(A)**: 多数派可用即可服务
- **分区容忍(P)**: 网络分区时自动选择多数派

## 1.3.4 决策检查清单

### 技术维度检查

- [ ] 吞吐量需求是否明确？
- [ ] 延迟要求是否量化？
- [ ] 持久化需求是否必需？
- [ ] 协议兼容性是否重要？
- [ ] 团队技能是否匹配？

### 运维维度检查

- [ ] 部署复杂度是否可接受？
- [ ] 监控告警是否完善？
- [ ] 故障恢复时间是否满足SLA？
- [ ] 扩容成本是否可控？
- [ ] 学习曲线是否合理？

### 业务维度检查

- [ ] 业务场景是否明确？
- [ ] 数据规模是否可预估？
- [ ] 合规要求是否满足？
- [ ] 成本预算是否充足？
- [ ] 技术路线是否一致？

## 1.3.5 决策分析参考资源

### CAP定理参考

- **Brewer's CAP Theorem**: [CAP Theorem - Wikipedia](https://en.wikipedia.org/wiki/CAP_theorem)
- **CAP应用**: [CAP Theorem Explained](https://www.ibm.com/cloud/learn/cap-theorem)
- **一致性模型**: [Consistency Models](https://en.wikipedia.org/wiki/Consistency_model)

### 技术选型参考

- **消息队列选型**: [Message Queue Comparison](https://www.cloudamqp.com/blog/2015-05-18-part1-rabbitmq-for-beginners-what-is-message-queuing.html)
- **Kafka选型指南**: [When to Use Kafka](https://kafka.apache.org/documentation/#uses)
- **MQTT选型指南**: [MQTT Use Cases](https://www.hivemq.com/mqtt-use-cases/)
- **NATS选型指南**: [NATS Use Cases](https://docs.nats.io/nats-concepts/overview)

### 决策方法论参考

- **架构决策记录**: [Architecture Decision Records](https://adr.github.io/)
- **技术选型框架**: [Technology Selection Framework](https://martinfowler.com/articles/technology-radar.html)

---

**参考来源**:

- 基于concept01.md内容整理
- CAP定理理论（Eric Brewer）
- Kafka、MQTT、NATS官方选型指南
- 架构决策方法论和实践
