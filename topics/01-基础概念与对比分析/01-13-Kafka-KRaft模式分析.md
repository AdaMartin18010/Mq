# 1.13 Kafka KRaftæ¨¡å¼æ·±åº¦åˆ†æ

## ç›®å½•

- [1.13 Kafka KRaftæ¨¡å¼æ·±åº¦åˆ†æ](#113-kafka-kraftæ¨¡å¼æ·±åº¦åˆ†æ)
  - [ç›®å½•](#ç›®å½•)
  - [1.13.1 KRaftæ¨¡å¼æ¦‚è¿°](#1131-kraftæ¨¡å¼æ¦‚è¿°)
    - [ä»€ä¹ˆæ˜¯KRaftæ¨¡å¼](#ä»€ä¹ˆæ˜¯kraftæ¨¡å¼)
    - [KRaftæ¨¡å¼çš„å†å²æ¼”è¿›](#kraftæ¨¡å¼çš„å†å²æ¼”è¿›)
    - [KRaft vs ZooKeeperå¯¹æ¯”](#kraft-vs-zookeeperå¯¹æ¯”)
  - [1.13.2 KRaftæ¨¡å¼æ ¸å¿ƒæ¶æ„](#1132-kraftæ¨¡å¼æ ¸å¿ƒæ¶æ„)
    - [å…ƒæ•°æ®ç®¡ç†æ¶æ„](#å…ƒæ•°æ®ç®¡ç†æ¶æ„)
    - [Controller Quorumæœºåˆ¶](#controller-quorumæœºåˆ¶)
    - [å…ƒæ•°æ®å­˜å‚¨æœºåˆ¶](#å…ƒæ•°æ®å­˜å‚¨æœºåˆ¶)
  - [1.13.3 KRaftæ¨¡å¼æŠ€æœ¯ç‰¹æ€§](#1133-kraftæ¨¡å¼æŠ€æœ¯ç‰¹æ€§)
    - [æ€§èƒ½ä¼˜åŠ¿](#æ€§èƒ½ä¼˜åŠ¿)
    - [è¿ç»´ç®€åŒ–](#è¿ç»´ç®€åŒ–)
    - [æ‰©å±•æ€§æå‡](#æ‰©å±•æ€§æå‡)
    - [æ•…éšœæ¢å¤æœºåˆ¶](#æ•…éšœæ¢å¤æœºåˆ¶)
  - [1.13.4 KRaftæ¨¡å¼è¿ç§»æŒ‡å—](#1134-kraftæ¨¡å¼è¿ç§»æŒ‡å—)
    - [è¿ç§»å‰å‡†å¤‡](#è¿ç§»å‰å‡†å¤‡)
    - [è¿ç§»æ­¥éª¤](#è¿ç§»æ­¥éª¤)
    - [è¿ç§»åéªŒè¯](#è¿ç§»åéªŒè¯)
    - [å›æ»šç­–ç•¥](#å›æ»šç­–ç•¥)
  - [1.13.5 KRaftæ¨¡å¼æœ€ä½³å®è·µ](#1135-kraftæ¨¡å¼æœ€ä½³å®è·µ)
    - [ControllerèŠ‚ç‚¹é…ç½®](#controllerèŠ‚ç‚¹é…ç½®)
    - [å…ƒæ•°æ®å­˜å‚¨é…ç½®](#å…ƒæ•°æ®å­˜å‚¨é…ç½®)
    - [ç›‘æ§å’Œå‘Šè­¦](#ç›‘æ§å’Œå‘Šè­¦)
    - [æ•…éšœå¤„ç†](#æ•…éšœå¤„ç†)
  - [1.13.6 KRaftæ¨¡å¼ä¸ZooKeeperæ¨¡å¼å¯¹æ¯”çŸ©é˜µ](#1136-kraftæ¨¡å¼ä¸zookeeperæ¨¡å¼å¯¹æ¯”çŸ©é˜µ)
  - [1.13.7 KRaftæ¨¡å¼å‚è€ƒèµ„æº](#1137-kraftæ¨¡å¼å‚è€ƒèµ„æº)
    - [å®˜æ–¹æ–‡æ¡£](#å®˜æ–¹æ–‡æ¡£)
    - [æŠ€æœ¯åšå®¢](#æŠ€æœ¯åšå®¢)
    - [ç”Ÿäº§æ¡ˆä¾‹](#ç”Ÿäº§æ¡ˆä¾‹)

---

## 1.13.1 KRaftæ¨¡å¼æ¦‚è¿°

### ä»€ä¹ˆæ˜¯KRaftæ¨¡å¼

**KRaftï¼ˆKafka Raftï¼‰æ¨¡å¼**æ˜¯Apache Kafkaä»3.3ç‰ˆæœ¬å¼€å§‹å¼•å…¥çš„æ–°å…ƒæ•°æ®ç®¡ç†æ¨¡å¼ï¼Œç”¨äºæ›¿ä»£ä¼ ç»Ÿçš„ZooKeeperä¾èµ–ã€‚KRaftæ¨¡å¼ä½¿ç”¨Raftå…±è¯†ç®—æ³•åœ¨Kafkaé›†ç¾¤å†…éƒ¨ç®¡ç†å…ƒæ•°æ®ï¼Œå®ç°äº†å®Œå…¨è‡ªåŒ…å«çš„Kafkaé›†ç¾¤ã€‚

**æ ¸å¿ƒç‰¹ç‚¹**ï¼š

- âœ… **æ— å¤–éƒ¨ä¾èµ–**ï¼šä¸å†éœ€è¦ZooKeeperï¼ŒKafkaé›†ç¾¤å®Œå…¨è‡ªç®¡ç†
- âœ… **ç®€åŒ–æ¶æ„**ï¼šå‡å°‘ç»„ä»¶æ•°é‡ï¼Œé™ä½è¿ç»´å¤æ‚åº¦
- âœ… **æ€§èƒ½æå‡**ï¼šå…ƒæ•°æ®æ“ä½œå»¶è¿Ÿé™ä½ï¼Œæ”¯æŒæ›´å¤§è§„æ¨¡é›†ç¾¤
- âœ… **ç”Ÿäº§å°±ç»ª**ï¼šKafka 3.5+ç‰ˆæœ¬å®Œå…¨ç”Ÿäº§å°±ç»ª

**å‚è€ƒ**: [KIP-500: Replace ZooKeeper with a Self-Managed Metadata Quorum](https://cwiki.apache.org/confluence/display/KAFKA/KIP-500%3A+Replace+ZooKeeper+with+a+Self-Managed+Metadata+Quorum)

### KRaftæ¨¡å¼çš„å†å²æ¼”è¿›

| ç‰ˆæœ¬ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| **Kafka 2.8.0** | å®éªŒæ€§ | é¦–æ¬¡å¼•å…¥KRaftæ¨¡å¼ï¼ˆKIP-500ï¼‰ï¼Œä»…ç”¨äºå¼€å‘æµ‹è¯• |
| **Kafka 3.0.0** | æ—©æœŸè®¿é—® | KRaftæ¨¡å¼å¯ç”¨äºéå…³é”®åœºæ™¯ |
| **Kafka 3.3.0** | ç”Ÿäº§å°±ç»ª | KRaftæ¨¡å¼æ­£å¼ç”Ÿäº§å°±ç»ªï¼Œæ”¯æŒå®Œæ•´åŠŸèƒ½ |
| **Kafka 3.5.0** | å®Œå…¨ç§»é™¤ | ç§»é™¤ZooKeeperæ”¯æŒï¼Œä»…æ”¯æŒKRaftæ¨¡å¼ |
| **Kafka 3.6.0+** | æŒç»­ä¼˜åŒ– | æ€§èƒ½ä¼˜åŒ–å’ŒåŠŸèƒ½å¢å¼º |

**å½“å‰çŠ¶æ€**ï¼ˆ2025å¹´ï¼‰ï¼š

- âœ… **Kafka 3.5+**: å®Œå…¨ç§»é™¤ZooKeeperï¼Œä»…æ”¯æŒKRaftæ¨¡å¼
- âœ… **ç”Ÿäº§ç¯å¢ƒ**: å¤§é‡ç”Ÿäº§ç¯å¢ƒå·²è¿ç§»åˆ°KRaftæ¨¡å¼
- âœ… **æ€§èƒ½éªŒè¯**: æ€§èƒ½ä¼˜äºZooKeeperæ¨¡å¼ï¼Œå»¶è¿Ÿé™ä½50%+

### KRaft vs ZooKeeperå¯¹æ¯”

| ç»´åº¦ | ZooKeeperæ¨¡å¼ | KRaftæ¨¡å¼ | ä¼˜åŠ¿æ–¹ |
|------|--------------|-----------|--------|
| **å¤–éƒ¨ä¾èµ–** | éœ€è¦ZooKeeperé›†ç¾¤ | æ— å¤–éƒ¨ä¾èµ– | âœ… KRaft |
| **ç»„ä»¶æ•°é‡** | Kafka + ZooKeeper | ä»…Kafka | âœ… KRaft |
| **å…ƒæ•°æ®å»¶è¿Ÿ** | 10-50ms | 1-5ms | âœ… KRaft |
| **é›†ç¾¤è§„æ¨¡** | æ”¯æŒæ•°åƒåˆ†åŒº | æ”¯æŒç™¾ä¸‡çº§åˆ†åŒº | âœ… KRaft |
| **å¯åŠ¨æ—¶é—´** | 30-60ç§’ | 5-10ç§’ | âœ… KRaft |
| **æ•…éšœæ¢å¤** | éœ€è¦ZooKeeperé€‰ä¸¾ | å†…ç½®Rafté€‰ä¸¾ | âœ… KRaft |
| **è¿ç»´å¤æ‚åº¦** | é«˜ï¼ˆä¸¤å¥—ç³»ç»Ÿï¼‰ | ä½ï¼ˆå•ä¸€ç³»ç»Ÿï¼‰ | âœ… KRaft |
| **æˆç†Ÿåº¦** | éå¸¸æˆç†Ÿ | è¾ƒæ–°ï¼ˆ2023+ï¼‰ | âš ï¸ ZooKeeper |

---

## 1.13.2 KRaftæ¨¡å¼æ ¸å¿ƒæ¶æ„

### å…ƒæ•°æ®ç®¡ç†æ¶æ„

**KRaftæ¨¡å¼æ¶æ„å›¾**ï¼š

```text
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Kafka KRaftæ¨¡å¼é›†ç¾¤æ¶æ„                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Controller-1    â”‚  â”‚  Controller-2    â”‚  â”‚  Controller-3    â”‚
â”‚  (Leader)        â”‚  â”‚  (Follower)      â”‚  â”‚  (Follower)      â”‚
â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Raft Log   â”‚ â”‚  â”‚  â”‚ Raft Log   â”‚ â”‚  â”‚  â”‚ Raft Log   â”‚ â”‚
â”‚  â”‚ (å…ƒæ•°æ®)    â”‚ â”‚  â”‚  â”‚ (å…ƒæ•°æ®)    â”‚ â”‚  â”‚  â”‚ (å…ƒæ•°æ®)    â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                     â”‚                     â”‚
         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚   Raft Consensus     â”‚
                    â”‚   (å…ƒæ•°æ®ä¸€è‡´æ€§)      â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                               â”‚
         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
         â”‚                     â”‚                     â”‚
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚   Broker-1       â”‚  â”‚   Broker-2       â”‚  â”‚   Broker-3       â”‚
â”‚   (æ•°æ®èŠ‚ç‚¹)      â”‚  â”‚   (æ•°æ®èŠ‚ç‚¹)      â”‚  â”‚   (æ•°æ®èŠ‚ç‚¹)      â”‚
â”‚                  â”‚  â”‚                  â”‚  â”‚                  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
â”‚  â”‚ Partition  â”‚ â”‚  â”‚  â”‚ Partition  â”‚ â”‚  â”‚  â”‚ Partition  â”‚ â”‚
â”‚  â”‚ (æ•°æ®å­˜å‚¨)  â”‚ â”‚  â”‚  â”‚ (æ•°æ®å­˜å‚¨)  â”‚ â”‚  â”‚  â”‚ (æ•°æ®å­˜å‚¨)  â”‚ â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**æ¶æ„ç‰¹ç‚¹**ï¼š

1. **Controller Quorum**ï¼š3-5ä¸ªControllerèŠ‚ç‚¹ç»„æˆRafté›†ç¾¤
2. **å…ƒæ•°æ®å­˜å‚¨**ï¼šå…ƒæ•°æ®å­˜å‚¨åœ¨ControllerèŠ‚ç‚¹çš„Raft Logä¸­
3. **BrokerèŠ‚ç‚¹**ï¼šä»…è´Ÿè´£æ•°æ®å­˜å‚¨å’Œæ¶ˆæ¯è·¯ç”±ï¼Œä¸ç®¡ç†å…ƒæ•°æ®
4. **æ— ZooKeeper**ï¼šå®Œå…¨ç§»é™¤ZooKeeperä¾èµ–

### Controller Quorumæœºåˆ¶

**Controllerè§’è‰²**ï¼š

- **Controller Leader**ï¼šå¤„ç†æ‰€æœ‰å…ƒæ•°æ®å˜æ›´è¯·æ±‚
- **Controller Follower**ï¼šå¤åˆ¶Leaderçš„å…ƒæ•°æ®å˜æ›´
- **Controller Candidate**ï¼šé€‰ä¸¾è¿‡ç¨‹ä¸­çš„ä¸´æ—¶çŠ¶æ€

**Raftå…±è¯†æµç¨‹**ï¼š

```text
1. å®¢æˆ·ç«¯è¯·æ±‚å…ƒæ•°æ®å˜æ›´
   â†“
2. Controller Leaderæ¥æ”¶è¯·æ±‚
   â†“
3. Leaderå†™å…¥æœ¬åœ°Raft Log
   â†“
4. Leaderå‘Followerå‘é€AppendEntries
   â†“
5. å¤šæ•°Followerç¡®è®¤ï¼ˆQuorumï¼‰
   â†“
6. Leaderæäº¤å˜æ›´ï¼Œé€šçŸ¥Broker
   â†“
7. Brokeræ›´æ–°æœ¬åœ°å…ƒæ•°æ®ç¼“å­˜
```

**Quorumå¤§å°**ï¼š

| ControllerèŠ‚ç‚¹æ•° | Quorumå¤§å° | å®¹é”™èƒ½åŠ› |
|-----------------|-----------|---------|
| 3 | 2 | å®¹å¿1ä¸ªèŠ‚ç‚¹æ•…éšœ |
| 5 | 3 | å®¹å¿2ä¸ªèŠ‚ç‚¹æ•…éšœ |
| 7 | 4 | å®¹å¿3ä¸ªèŠ‚ç‚¹æ•…éšœ |

**æ¨èé…ç½®**ï¼šç”Ÿäº§ç¯å¢ƒå»ºè®®ä½¿ç”¨5ä¸ªControllerèŠ‚ç‚¹ï¼Œå¹³è¡¡æ€§èƒ½å’Œå®¹é”™èƒ½åŠ›ã€‚

### å…ƒæ•°æ®å­˜å‚¨æœºåˆ¶

**å…ƒæ•°æ®ç±»å‹**ï¼š

- **Topicå…ƒæ•°æ®**ï¼šTopicåç§°ã€åˆ†åŒºæ•°ã€å‰¯æœ¬é…ç½®
- **Brokerå…ƒæ•°æ®**ï¼šBroker IDã€åœ°å€ã€çŠ¶æ€
- **åˆ†åŒºå…ƒæ•°æ®**ï¼šåˆ†åŒºLeaderã€ISRåˆ—è¡¨ã€OffsetèŒƒå›´
- **ACLå…ƒæ•°æ®**ï¼šè®¿é—®æ§åˆ¶åˆ—è¡¨
- **é…ç½®å…ƒæ•°æ®**ï¼šTopicå’ŒBrokeré…ç½®

**å­˜å‚¨æ ¼å¼**ï¼š

- **Raft Log**ï¼šé¡ºåºå†™å…¥çš„æ—¥å¿—æ–‡ä»¶
- **Snapshot**ï¼šå®šæœŸå¿«ç…§ï¼ŒåŠ é€Ÿæ¢å¤
- **æœ¬åœ°å­˜å‚¨**ï¼šæ¯ä¸ªControllerèŠ‚ç‚¹ç‹¬ç«‹å­˜å‚¨

**å‚è€ƒ**: [KRaft Metadata Storage](https://kafka.apache.org/documentation/#kraft_metadata)

---

## 1.13.3 KRaftæ¨¡å¼æŠ€æœ¯ç‰¹æ€§

### æ€§èƒ½ä¼˜åŠ¿

**å»¶è¿Ÿå¯¹æ¯”**ï¼ˆåŸºäºå®˜æ–¹åŸºå‡†æµ‹è¯•ï¼‰ï¼š

| æ“ä½œç±»å‹ | ZooKeeperæ¨¡å¼ | KRaftæ¨¡å¼ | æå‡ |
|---------|--------------|-----------|------|
| **Topicåˆ›å»º** | 50-100ms | 10-20ms | 70%â†“ |
| **åˆ†åŒºé‡åˆ†é…** | 5-10ç§’ | 1-2ç§’ | 80%â†“ |
| **Brokeræ³¨å†Œ** | 100-200ms | 20-40ms | 75%â†“ |
| **å…ƒæ•°æ®æŸ¥è¯¢** | 10-50ms | 1-5ms | 90%â†“ |

**ååé‡æå‡**ï¼š

- âœ… **å…ƒæ•°æ®æ“ä½œååé‡**ï¼šæå‡3-5å€
- âœ… **é›†ç¾¤å¯åŠ¨æ—¶é—´**ï¼šä»30-60ç§’é™ä½åˆ°5-10ç§’
- âœ… **æ”¯æŒæ›´å¤§è§„æ¨¡**ï¼šä»æ•°åƒåˆ†åŒºæ‰©å±•åˆ°ç™¾ä¸‡çº§åˆ†åŒº

**å‚è€ƒ**: [Kafka KRaft Performance Improvements](https://www.confluent.io/blog/kafka-raft-kip-500-removes-zookeeper-dependency/)

### è¿ç»´ç®€åŒ–

**ç»„ä»¶å‡å°‘**ï¼š

```text
ZooKeeperæ¨¡å¼ï¼š
â”œâ”€â”€ ZooKeeperé›†ç¾¤ï¼ˆ3-5èŠ‚ç‚¹ï¼‰
â”‚   â”œâ”€â”€ é…ç½®ç®¡ç†
â”‚   â”œâ”€â”€ ç›‘æ§å‘Šè­¦
â”‚   â””â”€â”€ æ•…éšœå¤„ç†
â””â”€â”€ Kafkaé›†ç¾¤
    â”œâ”€â”€ BrokerèŠ‚ç‚¹
    â””â”€â”€ Controllerï¼ˆä¾èµ–ZooKeeperï¼‰

KRaftæ¨¡å¼ï¼š
â””â”€â”€ Kafkaé›†ç¾¤
    â”œâ”€â”€ ControllerèŠ‚ç‚¹ï¼ˆå†…ç½®Raftï¼‰
    â””â”€â”€ BrokerèŠ‚ç‚¹
```

**è¿ç»´ä¼˜åŠ¿**ï¼š

- âœ… **å•ä¸€ç³»ç»Ÿ**ï¼šåªéœ€è¿ç»´Kafkaé›†ç¾¤
- âœ… **ç»Ÿä¸€ç›‘æ§**ï¼šæ‰€æœ‰æŒ‡æ ‡åœ¨Kafkaä¸­
- âœ… **ç®€åŒ–éƒ¨ç½²**ï¼šå‡å°‘éƒ¨ç½²æ­¥éª¤å’Œé…ç½®
- âœ… **é™ä½æ•…éšœç‚¹**ï¼šå‡å°‘ZooKeeperæ•…éšœé£é™©

### æ‰©å±•æ€§æå‡

**é›†ç¾¤è§„æ¨¡é™åˆ¶**ï¼š

| ç»´åº¦ | ZooKeeperæ¨¡å¼ | KRaftæ¨¡å¼ |
|------|--------------|-----------|
| **æœ€å¤§åˆ†åŒºæ•°** | 10,000-50,000 | 1,000,000+ |
| **æœ€å¤§Topicæ•°** | 5,000-10,000 | 100,000+ |
| **å…ƒæ•°æ®å¤§å°** | å—ZooKeeperé™åˆ¶ | æ— ç¡¬æ€§é™åˆ¶ |
| **Brokeræ•°é‡** | æ•°ç™¾ä¸ª | æ•°åƒä¸ª |

**æ‰©å±•æ€§ä¼˜åŠ¿**ï¼š

- âœ… **æ°´å¹³æ‰©å±•**ï¼šControllerèŠ‚ç‚¹å¯ç‹¬ç«‹æ‰©å±•
- âœ… **å…ƒæ•°æ®å®¹é‡**ï¼šä¸å—ZooKeeperå†…å­˜é™åˆ¶
- âœ… **åˆ†åŒºç®¡ç†**ï¼šæ”¯æŒæ›´å¤§è§„æ¨¡åˆ†åŒºæ“ä½œ

### æ•…éšœæ¢å¤æœºåˆ¶

**Controlleræ•…éšœæ¢å¤**ï¼š

```text
åœºæ™¯1ï¼šController Followeræ•…éšœ
â”œâ”€â”€ Leaderç»§ç»­æœåŠ¡
â”œâ”€â”€ å…¶ä»–Followerç»§ç»­å¤åˆ¶
â””â”€â”€ æ•…éšœèŠ‚ç‚¹æ¢å¤åè‡ªåŠ¨åŒæ­¥

åœºæ™¯2ï¼šController Leaderæ•…éšœ
â”œâ”€â”€ Followeræ£€æµ‹Leaderæ•…éšœï¼ˆå¿ƒè·³è¶…æ—¶ï¼‰
â”œâ”€â”€ è§¦å‘Leaderé€‰ä¸¾ï¼ˆRaftç®—æ³•ï¼‰
â”œâ”€â”€ æ–°Leaderé€‰ä¸¾æˆåŠŸï¼ˆå¤šæ•°æŠ•ç¥¨ï¼‰
â””â”€â”€ æ–°Leaderç»§ç»­æœåŠ¡ï¼Œå…ƒæ•°æ®ä¸ä¸¢å¤±
```

**æ¢å¤æ—¶é—´å¯¹æ¯”**ï¼š

| æ•…éšœç±»å‹ | ZooKeeperæ¨¡å¼ | KRaftæ¨¡å¼ |
|---------|--------------|-----------|
| **Controlleræ•…éšœ** | 10-30ç§’ | 3-5ç§’ |
| **å…ƒæ•°æ®æ¢å¤** | 30-60ç§’ | 5-10ç§’ |
| **é›†ç¾¤å¯åŠ¨** | 30-60ç§’ | 5-10ç§’ |

---

## 1.13.4 KRaftæ¨¡å¼è¿ç§»æŒ‡å—

### è¿ç§»å‰å‡†å¤‡

**1. ç‰ˆæœ¬æ£€æŸ¥**ï¼š

```bash
# æ£€æŸ¥å½“å‰Kafkaç‰ˆæœ¬
kafka-broker-api-versions.sh --bootstrap-server localhost:9092

# è¦æ±‚ï¼šKafka 3.3.0+ æ”¯æŒKRaftæ¨¡å¼
# æ¨èï¼šKafka 3.5.0+ å®Œå…¨ç§»é™¤ZooKeeper
```

**2. ç¯å¢ƒè¯„ä¼°**ï¼š

- [ ] è¯„ä¼°å½“å‰ZooKeeperé›†ç¾¤çŠ¶æ€
- [ ] è¯„ä¼°Kafkaé›†ç¾¤è§„æ¨¡ï¼ˆTopicæ•°ã€åˆ†åŒºæ•°ï¼‰
- [ ] è¯„ä¼°å…ƒæ•°æ®å¤§å°
- [ ] è¯„ä¼°ä¸šåŠ¡å½±å“èŒƒå›´
- [ ] å‡†å¤‡å›æ»šæ–¹æ¡ˆ

**3. å¤‡ä»½æ•°æ®**ï¼š

```bash
# å¤‡ä»½ZooKeeperæ•°æ®
zkCli.sh -server localhost:2181
> get /config/topics
> get /brokers/ids

# å¤‡ä»½Kafkaé…ç½®
cp server.properties server.properties.backup
```

### è¿ç§»æ­¥éª¤

**é˜¶æ®µ1ï¼šå‡†å¤‡KRaft ControllerèŠ‚ç‚¹**

```properties
# controller.properties
process.roles=controller
node.id=1
controller.quorum.voters=1@controller1:9093,2@controller2:9093,3@controller3:9093
listeners=PLAINTEXT://:9093
controller.listener.names=PLAINTEXT
log.dirs=/var/kafka/kraft-controller
```

**é˜¶æ®µ2ï¼šå¯åŠ¨Controlleré›†ç¾¤**

```bash
# æ ¼å¼åŒ–å…ƒæ•°æ®å­˜å‚¨ï¼ˆé¦–æ¬¡å¯åŠ¨ï¼‰
kafka-storage.sh format -t <cluster-id> -c controller.properties

# å¯åŠ¨ControllerèŠ‚ç‚¹
kafka-server-start.sh controller.properties
```

**é˜¶æ®µ3ï¼šè¿ç§»BrokerèŠ‚ç‚¹**

```properties
# broker.propertiesï¼ˆKRaftæ¨¡å¼ï¼‰
process.roles=broker
node.id=1
controller.quorum.voters=1@controller1:9093,2@controller2:9093,3@controller3:9093
listeners=PLAINTEXT://:9092
log.dirs=/var/kafka/kraft-broker
```

**é˜¶æ®µ4ï¼šé€æ­¥è¿ç§»**

```text
1. å¯åŠ¨KRaft Controlleré›†ç¾¤ï¼ˆ3-5èŠ‚ç‚¹ï¼‰
   â†“
2. å¯åŠ¨ç¬¬ä¸€ä¸ªKRaft Brokerï¼ˆéªŒè¯ï¼‰
   â†“
3. é€æ­¥è¿ç§»å…¶ä»–BrokerèŠ‚ç‚¹
   â†“
4. éªŒè¯æ‰€æœ‰åŠŸèƒ½æ­£å¸¸
   â†“
5. åœæ­¢ZooKeeperé›†ç¾¤
```

**å‚è€ƒ**: [Migrating from ZooKeeper to KRaft](https://kafka.apache.org/documentation/#kraft_migration)

### è¿ç§»åéªŒè¯

**1. åŠŸèƒ½éªŒè¯**ï¼š

```bash
# éªŒè¯Topicåˆ›å»º
kafka-topics.sh --create --topic test-topic --bootstrap-server localhost:9092

# éªŒè¯æ¶ˆæ¯ç”Ÿäº§æ¶ˆè´¹
kafka-console-producer.sh --topic test-topic --bootstrap-server localhost:9092
kafka-console-consumer.sh --topic test-topic --bootstrap-server localhost:9092

# éªŒè¯å…ƒæ•°æ®æŸ¥è¯¢
kafka-metadata-shell.sh --snapshot /var/kafka/kraft-controller/__cluster_metadata-0/00000000000000000000.log
```

**2. æ€§èƒ½éªŒè¯**ï¼š

- [ ] å…ƒæ•°æ®æ“ä½œå»¶è¿Ÿ < 10ms
- [ ] Topicåˆ›å»ºæ—¶é—´ < 1ç§’
- [ ] åˆ†åŒºé‡åˆ†é…æ—¶é—´ < 5ç§’
- [ ] é›†ç¾¤å¯åŠ¨æ—¶é—´ < 10ç§’

**3. ç›‘æ§éªŒè¯**ï¼š

- [ ] ControllerèŠ‚ç‚¹å¥åº·æ£€æŸ¥
- [ ] Rafté€‰ä¸¾æŒ‡æ ‡æ­£å¸¸
- [ ] å…ƒæ•°æ®åŒæ­¥æ­£å¸¸
- [ ] æ— é”™è¯¯æ—¥å¿—

### å›æ»šç­–ç•¥

**å›æ»šæ¡ä»¶**ï¼š

- âŒ å…ƒæ•°æ®ä¸¢å¤±æˆ–æŸå
- âŒ æ€§èƒ½ä¸¥é‡ä¸‹é™
- âŒ åŠŸèƒ½å¼‚å¸¸æ— æ³•æ¢å¤

**å›æ»šæ­¥éª¤**ï¼š

```text
1. åœæ­¢KRaft Kafkaé›†ç¾¤
   â†“
2. æ¢å¤ZooKeeperé›†ç¾¤
   â†“
3. æ¢å¤Brokeré…ç½®ï¼ˆZooKeeperæ¨¡å¼ï¼‰
   â†“
4. å¯åŠ¨ZooKeeperæ¨¡å¼Kafkaé›†ç¾¤
   â†“
5. éªŒè¯åŠŸèƒ½æ­£å¸¸
```

---

## 1.13.5 KRaftæ¨¡å¼æœ€ä½³å®è·µ

### ControllerèŠ‚ç‚¹é…ç½®

**æ¨èé…ç½®**ï¼š

```properties
# controller.properties
# ControllerèŠ‚ç‚¹æ•°é‡ï¼šç”Ÿäº§ç¯å¢ƒæ¨è5ä¸ª
process.roles=controller
node.id=1

# Controller Quorumé…ç½®
controller.quorum.voters=1@controller1:9093,2@controller2:9093,3@controller3:9093,4@controller4:9093,5@controller5:9093

# ç›‘å¬å™¨é…ç½®
listeners=PLAINTEXT://:9093
controller.listener.names=PLAINTEXT

# å…ƒæ•°æ®å­˜å‚¨
metadata.log.dir=/var/kafka/kraft-metadata
metadata.log.segment.bytes=1073741824  # 1GB
metadata.log.max.snapshot.interval.ms=3600000  # 1å°æ—¶

# æ€§èƒ½ä¼˜åŒ–
num.network.threads=8
num.io.threads=8
```

**ç¡¬ä»¶è¦æ±‚**ï¼š

- **CPU**: 4æ ¸+ï¼ˆControllerèŠ‚ç‚¹ï¼‰
- **å†…å­˜**: 8GB+ï¼ˆå…ƒæ•°æ®ç¼“å­˜ï¼‰
- **ç£ç›˜**: SSDï¼ˆå…ƒæ•°æ®æ—¥å¿—ï¼‰
- **ç½‘ç»œ**: ä½å»¶è¿Ÿç½‘ç»œï¼ˆRaftå…±è¯†ï¼‰

### å…ƒæ•°æ®å­˜å‚¨é…ç½®

**å­˜å‚¨è·¯å¾„**ï¼š

```properties
# å…ƒæ•°æ®æ—¥å¿—ç›®å½•
metadata.log.dir=/var/kafka/kraft-metadata

# æ¨èé…ç½®
metadata.log.segment.bytes=1073741824  # 1GBæ®µå¤§å°
metadata.log.retention.ms=604800000    # 7å¤©ä¿ç•™
metadata.log.max.snapshot.interval.ms=3600000  # 1å°æ—¶å¿«ç…§
```

**å¤‡ä»½ç­–ç•¥**ï¼š

- âœ… **å®šæœŸå¿«ç…§**ï¼šæ¯å°æ—¶ç”Ÿæˆå…ƒæ•°æ®å¿«ç…§
- âœ… **å¼‚åœ°å¤‡ä»½**ï¼šå®šæœŸå¤‡ä»½å…ƒæ•°æ®åˆ°å…¶ä»–å­˜å‚¨
- âœ… **ç‰ˆæœ¬æ§åˆ¶**ï¼šä¿ç•™å¤šä¸ªç‰ˆæœ¬çš„å…ƒæ•°æ®å¿«ç…§

### ç›‘æ§å’Œå‘Šè­¦

**å…³é”®æŒ‡æ ‡**ï¼š

| æŒ‡æ ‡ç±»å‹ | æŒ‡æ ‡åç§° | å‘Šè­¦é˜ˆå€¼ |
|---------|---------|---------|
| **å¯ç”¨æ€§** | ControllerèŠ‚ç‚¹å¥åº· | ä»»ä½•èŠ‚ç‚¹æ•…éšœ |
| **æ€§èƒ½** | å…ƒæ•°æ®æ“ä½œå»¶è¿Ÿ | P99 > 10ms |
| **ä¸€è‡´æ€§** | Rafté€‰ä¸¾æ¬¡æ•° | é¢‘ç¹é€‰ä¸¾ï¼ˆ>1æ¬¡/å°æ—¶ï¼‰ |
| **å­˜å‚¨** | å…ƒæ•°æ®æ—¥å¿—å¤§å° | > 10GB |

**ç›‘æ§å·¥å…·**ï¼š

- **JMXæŒ‡æ ‡**ï¼š`kafka.controller:*`
- **æ—¥å¿—ç›‘æ§**ï¼šControlleræ—¥å¿—ä¸­çš„é”™è¯¯å’Œè­¦å‘Š
- **å¥åº·æ£€æŸ¥**ï¼šå®šæœŸæ£€æŸ¥ControllerèŠ‚ç‚¹çŠ¶æ€

### æ•…éšœå¤„ç†

**å¸¸è§æ•…éšœåœºæ™¯**ï¼š

1. **Controller Leaderæ•…éšœ**
   - **ç°è±¡**ï¼šå…ƒæ•°æ®æ“ä½œå¤±è´¥
   - **å¤„ç†**ï¼šç­‰å¾…è‡ªåŠ¨é€‰ä¸¾ï¼ˆ3-5ç§’ï¼‰
   - **é¢„é˜²**ï¼šç¡®ä¿ControllerèŠ‚ç‚¹æ•°é‡ >= 3

2. **å…ƒæ•°æ®æ—¥å¿—æŸå**
   - **ç°è±¡**ï¼šControllerå¯åŠ¨å¤±è´¥
   - **å¤„ç†**ï¼šä»å¿«ç…§æ¢å¤æˆ–ä»å…¶ä»–èŠ‚ç‚¹å¤åˆ¶
   - **é¢„é˜²**ï¼šå®šæœŸå¤‡ä»½å…ƒæ•°æ®

3. **ç½‘ç»œåˆ†åŒº**
   - **ç°è±¡**ï¼šRaftæ— æ³•è¾¾æˆå…±è¯†
   - **å¤„ç†**ï¼šä¿®å¤ç½‘ç»œåè‡ªåŠ¨æ¢å¤
   - **é¢„é˜²**ï¼šç¡®ä¿ç½‘ç»œç¨³å®šï¼Œä½¿ç”¨ä½å»¶è¿Ÿç½‘ç»œ

---

## 1.13.6 KRaftæ¨¡å¼ä¸ZooKeeperæ¨¡å¼å¯¹æ¯”çŸ©é˜µ

| ç»´åº¦ | ZooKeeperæ¨¡å¼ | KRaftæ¨¡å¼ | æ¨è |
|------|--------------|-----------|------|
| **æ¶æ„å¤æ‚åº¦** | é«˜ï¼ˆä¸¤å¥—ç³»ç»Ÿï¼‰ | ä½ï¼ˆå•ä¸€ç³»ç»Ÿï¼‰ | âœ… KRaft |
| **éƒ¨ç½²å¤æ‚åº¦** | é«˜ï¼ˆéœ€è¦ZooKeeperï¼‰ | ä½ï¼ˆä»…Kafkaï¼‰ | âœ… KRaft |
| **è¿ç»´æˆæœ¬** | é«˜ï¼ˆä¸¤å¥—ç›‘æ§ï¼‰ | ä½ï¼ˆç»Ÿä¸€ç›‘æ§ï¼‰ | âœ… KRaft |
| **æ€§èƒ½** | ä¸­ç­‰ | ä¼˜ç§€ | âœ… KRaft |
| **æ‰©å±•æ€§** | å—é™ | ä¼˜ç§€ | âœ… KRaft |
| **æˆç†Ÿåº¦** | éå¸¸æˆç†Ÿ | è¾ƒæ–° | âš ï¸ ZooKeeper |
| **ç”Ÿäº§å°±ç»ª** | âœ… æ˜¯ | âœ… æ˜¯ï¼ˆ3.3+ï¼‰ | âœ… ä¸¤è€… |
| **è¿ç§»æˆæœ¬** | - | ä¸­ç­‰ | - |

**é€‰å‹å»ºè®®**ï¼š

- **æ–°é¡¹ç›®**ï¼šâœ… ç›´æ¥ä½¿ç”¨KRaftæ¨¡å¼ï¼ˆKafka 3.5+ï¼‰
- **ç°æœ‰é¡¹ç›®**ï¼šğŸ”„ é€æ­¥è¿ç§»åˆ°KRaftæ¨¡å¼
- **å¤§è§„æ¨¡é›†ç¾¤**ï¼šâœ… ä¼˜å…ˆé€‰æ‹©KRaftæ¨¡å¼ï¼ˆæ‰©å±•æ€§æ›´å¥½ï¼‰

---

## 1.13.7 KRaftæ¨¡å¼å‚è€ƒèµ„æº

### å®˜æ–¹æ–‡æ¡£

- [KIP-500: KRaftæ¨¡å¼è®¾è®¡](https://cwiki.apache.org/confluence/display/KAFKA/KIP-500%3A+Replace+ZooKeeper+with+a+Self-Managed+Metadata+Quorum)
- [Kafka KRaftæ¨¡å¼æ–‡æ¡£](https://kafka.apache.org/documentation/#kraft)
- [KRaftè¿ç§»æŒ‡å—](https://kafka.apache.org/documentation/#kraft_migration)
- [KRaftå…ƒæ•°æ®å­˜å‚¨](https://kafka.apache.org/documentation/#kraft_metadata)

### æŠ€æœ¯åšå®¢

- [Confluent: Kafka Without ZooKeeper](https://www.confluent.io/blog/kafka-without-zookeeper-a-sneak-peek/)
- [Apache Kafka: KRaft Performance](https://kafka.apache.org/documentation/#kraft_performance)

### ç”Ÿäº§æ¡ˆä¾‹

- **LinkedIn**: å¤§è§„æ¨¡Kafkaé›†ç¾¤è¿ç§»åˆ°KRaftæ¨¡å¼
- **Netflix**: KRaftæ¨¡å¼æ€§èƒ½æå‡æ¡ˆä¾‹
- **Uber**: KRaftæ¨¡å¼è¿ç»´ç®€åŒ–æ¡ˆä¾‹

---

**æœ€åæ›´æ–°**: 2025-12-31
**é€‚ç”¨ç‰ˆæœ¬**: Kafka 3.3.0+ï¼ˆç”Ÿäº§å°±ç»ªï¼‰ï¼ŒKafka 3.5.0+ï¼ˆå®Œå…¨ç§»é™¤ZooKeeperï¼‰
